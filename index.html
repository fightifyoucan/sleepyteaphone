<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœ èŒ¶æœº</title>
    <link rel="icon" href="Gemini_Generated_Image_9nxbzu9nxbzu9nxb.png?v=2" type="image/png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="çœ èŒ¶æœº">
    <link rel="apple-touch-icon" href="Gemini_Generated_Image_9nxbzu9nxbzu9nxb.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- æ ¸å¿ƒåŸºç¡€ --- */
        body { display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(180deg, #fff5f7 0%, #ffeaf0 100%); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; overflow: hidden; user-select: none; }
        .mobile-container { width: 360px; height: 640px; background-color: #ffffff; border-radius: 40px; box-shadow: 0 10px 30px rgba(255, 182, 193, 0.3); position: relative; overflow: hidden; transform: scale(0.95); border: 10px solid #000000; }
        .screen { width: 100%; height: 100%; border-radius: 30px; background-color: transparent; background-size: cover; background-position: center; position: relative; display: flex; flex-direction: column; }
        .backdrop-blur { -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); }
        .dynamic-island { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 120px; height: 25px; background-color: #000; border-radius: 0 0 15px 15px; z-index: 300; pointer-events: none; }
        .time-and-date { text-align: center; color: white; z-index: 10; margin-bottom: 20px; }
        .time { font-size: 70px; font-weight: 600; }
        .date { font-size: 20px; font-weight: 400; }
        .home-indicator { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); width: 134px; height: 5px; background-color: rgba(0,0,0,0.4); border-radius: 2.5px; cursor: pointer; z-index: 310; }

        /* --- æ¡Œé¢å…ƒç´  --- */
        .home-content { display: flex; justify-content: center; padding: 20px; column-gap: 20px; }
        .app-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .app-icon { display: flex; flex-direction: column; align-items: center; text-align: center; color: white; font-size: 12px; text-shadow: 0 1px 3px rgba(0,0,0,0.15); cursor: pointer; transition: transform 0.2s; }
        .app-icon:active { transform: scale(0.9); }
        .app-icon-img { width: 60px; height: 60px; background-color: rgba(255,255,255,0.4); -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); border-radius: 15px; margin-bottom: 5px; display: flex; justify-content: center; align-items: center; font-size: 24px; box-shadow: 0 4px 10px rgba(255,182,193,0.1); }
        .love-widget { grid-column: span 2; grid-row: span 2; background-color: rgba(255,255,255,0.4); -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); border-radius: 22px; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.15); aspect-ratio: 1/1; }
        .love-widget .avatars { display: flex; gap: -15px; margin-bottom: 8px; }
        .love-widget .avatar-placeholder { width: 40px; height: 40px; border-radius: 50%; background-color: rgba(255,255,255,0.3); border: 2px solid white; background-size: cover; background-position: center; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 10px; color: rgba(255,255,255,0.7); }
        .love-widget .days-count { font-size: 24px; font-weight: 600; }
        .dock { position: absolute; bottom: 40px; left: 10px; right: 10px; height: 90px; background-color: rgba(255,255,255,0.5); border-radius: 34px; display: flex; justify-content: space-around; align-items: center; padding: 0 10px; z-index: 20; }

        /* --- App å®¹å™¨ --- */
        .app-page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: #fffafb; z-index: 200; display: flex; flex-direction: column; box-sizing: border-box; opacity: 0; transform: scale(0.1); border-radius: 44px; pointer-events: none; transform-origin: center; }
        .app-page.active { pointer-events: auto; animation: open-app 0.5s cubic-bezier(0.45, 0, 0.1, 1) forwards; }
        .app-page.closing { animation: close-app 0.4s cubic-bezier(0.8, 0, 0.2, 1) forwards; }
        @keyframes open-app { from { opacity: 0; transform: scale(0.1); border-radius: 44px; } to { opacity: 1; transform: scale(1); border-radius: 0; } }
        @keyframes close-app { from { opacity: 1; transform: scale(1); border-radius: 0; } to { opacity: 0; transform: scale(0.1); border-radius: 44px; } }
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 45px 15px 15px; background-color: rgba(255, 255, 255, 0.9); border-bottom: 1px solid rgba(0,0,0,0.05); flex-shrink: 0; }
        .app-content { flex-grow: 1; overflow-y: auto; }

        /* --- 520 App æ ·å¼ --- */
        .app-header-520 { background-color: #f7f7f7; border-bottom: 1px solid #e5e5e5; padding: 45px 15px 10px; display: flex; justify-content: center; align-items: center; position: relative; flex-shrink: 0; height: 90px; box-sizing: border-box; z-index: 10; }
        .app-header-520 .title { font-weight: 600; font-size: 17px; }
        .app-header-520 .close-btn-520 { position: absolute; left: 15px; color: #000; font-size: 16px; cursor: pointer; }
        .app-header-520 .add-btn-520 { position: absolute; right: 15px; color: #000; font-size: 24px; cursor: pointer; }
        .bottom-nav-520 { display: flex; justify-content: space-around; background-color: #f7f7f7; border-top: 1px solid #b2b2b2; padding-top: 6px; padding-bottom: 20px; flex-shrink: 0; z-index: 10; }
        .nav-item-520 { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: #8e8e93; cursor: pointer; }
        .nav-item-520.active { color: #07c160; }
        .nav-item-520 .icon { font-size: 24px; margin-bottom: 2px; }
        .page-content-520 { position: absolute; top: 0; left: 0; right: 0; bottom: 0; opacity: 0; pointer-events: none; overflow-y: auto; background-color: #fff; }
        .app-content-520-wrapper { flex: 1; position: relative; overflow: hidden; }
        .page-content-520.active { opacity: 1; pointer-events: auto; }
        
        .chat-list-item { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; background: #fff; margin:0; }
        .chat-list-avatar { width: 48px; height: 48px; border-radius: 6px; background-color: #e5e5e5; margin-right: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; overflow: hidden; }
        .chat-list-info { flex-grow: 1; overflow: hidden; }

        /* --- èŠå¤©è¯¦æƒ…é¡µæ ·å¼ (ä¿®å¤å¤´åƒä½ç½®) --- */
        .chat-conversation-page { display: flex; flex-direction: column; background-color: #ededed; }
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; padding-bottom: 20px; }
        .message-timestamp { text-align: center; color: #999; font-size: 12px; margin: 15px 0 5px 0; }
        
        /* ğŸŸ¢ ä¿®å¤æ ¸å¿ƒï¼šæ¶ˆæ¯è¡Œå¸ƒå±€ */
        .message-row { display: flex; margin-bottom: 12px; align-items: flex-start; width: 100%; }
        
        /* å¯¹æ–¹å‘çš„æ¶ˆæ¯ï¼šé»˜è®¤æ­£å‘ (å¤´åƒåœ¨å·¦) */
        .message-row.received { flex-direction: row; }
        .message-row.received .message-avatar { margin-right: 10px; margin-left: 0; }
        
        /* æˆ‘å‘çš„æ¶ˆæ¯ï¼šåå‘ (å¤´åƒåœ¨å³) */
        .message-row.sent { flex-direction: row-reverse; }
        .message-row.sent .message-avatar { margin-left: 10px; margin-right: 0; }

        .message-avatar { width: 40px; height: 40px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 20px; background: #fff; flex-shrink: 0; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: pointer; }
        
        .message-bubble { max-width: 70%; padding: 10px 14px; border-radius: 6px; font-size: 16px; line-height: 1.5; position: relative; word-wrap: break-word; }
        .message-bubble.sent { background-color: #95ec69; color: #000; }
        .message-bubble.received { background-color: #fff; color: #000; }
        .message-bubble.voice { display: flex; align-items: center; gap: 5px; cursor: pointer; min-width: 60px; }
        .message-bubble.image img { border-radius: 4px; max-width: 100%; display: block; }
        .message-bubble.transfer { background-color: #fa9d3b; color: white; padding: 15px; display: flex; flex-direction: column; min-width: 180px; }
        .message-bubble.location { background-color: #fff; padding: 5px; border: 1px solid #ddd; }
        
        .chat-footer { background-color: #f7f7f7; border-top: 1px solid #dcdcdc; transition: padding-bottom 0.2s; position: relative; z-index: 20;}
        .chat-input-bar { display: flex; align-items: center; padding: 8px 10px; gap: 8px; min-height: 50px; }
        .chat-btn-icon { width: 28px; height: 28px; border-radius: 50%; border: 1px solid #7f8389; display: flex; align-items: center; justify-content: center; font-size: 18px; color: #333; cursor: pointer; flex-shrink: 0; }
        .chat-input-field { flex-grow: 1; border: none; padding: 8px; border-radius: 6px; font-size: 16px; background: #fff; min-height: 36px; max-height: 100px; overflow-y: auto; }
        .chat-voice-btn { flex-grow: 1; text-align: center; padding: 8px; background: #fff; border-radius: 6px; font-weight: bold; font-size: 15px; border: 1px solid #ddd; cursor: pointer; user-select: none; }
        .chat-voice-btn:active { background: #dcdcdc; }
        .ai-reply-btn { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; border: none; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .plus-panel { height: 0; overflow: hidden; background: #f7f7f7; transition: height 0.2s; border-top: 1px solid #dcdcdc; }
        .plus-panel.open { height: 180px; padding: 20px; }
        .plus-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .plus-item { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; }
        .plus-icon-box { width: 50px; height: 50px; background: #fff; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; border: 1px solid #e5e5e5; }
        .plus-label { font-size: 11px; color: #888; }

        .voice-call-page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(180deg, #2b2b2b 0%, #1a1a1a 100%); z-index: 400; display: none; flex-direction: column; align-items: center; padding-top: 80px; color: white; }
        .voice-call-page.active { display: flex; }
        .call-avatar { width: 100px; height: 100px; border-radius: 15px; background: #555; margin-bottom: 20px; background-size: cover; background-position: center; }
        .call-status { font-size: 16px; margin-bottom: 5px; opacity: 0.8; }
        .call-timer { font-size: 24px; font-weight: 300; margin-bottom: 40px; }
        .call-transcript { width: 85%; height: 150px; background: rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; font-size: 14px; margin-bottom: 20px; overflow-y: auto; }
        .call-input-area { width: 85%; display: flex; gap: 10px; margin-bottom: 40px; }
        .call-input { flex: 1; background: rgba(255,255,255,0.2); border: none; padding: 10px; border-radius: 20px; color: white; }
        .call-actions { width: 100%; display: flex; justify-content: center; margin-top: auto; padding-bottom: 50px; }
        .hangup-btn { width: 60px; height: 60px; border-radius: 50%; background: #ff3b30; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; }

        .chat-details-page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #f2f2f7; z-index: 200; transform: translateX(100%); transition: transform 0.3s; display: flex; flex-direction: column; }
        .chat-details-page.active { transform: translateX(0); }

        /* --- æ ·å¼è¡¥ä¸ --- */
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 4px; color: #333; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 8px 12px; border: 1px solid #dcdcdc; border-radius: 8px; font-size: 16px; }
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #e5e5e5; }
        .wallpaper-options, .icon-style-options { display: flex; gap: 10px; margin-top: 8px; }
        .wallpaper-preview, .icon-style-preview { width: 40px; height: 60px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; background-size: cover; background-position: center; }
        
        /* ğŸŸ¢ ä¿®å¤ï¼šå£çº¸+å·å±…ä¸­ & å›¾æ ‡è™šçº¿æ¡† */
        .wallpaper-preview, .icon-style-preview { display: flex; justify-content: center; align-items: center; color: #ccc; font-weight: bold; font-size: 20px; }
        .dashed-border { border: 2px dashed #ccc !important; border-radius: 10px; } 
        
        .save-btn { background-color: #FFB6C1; color: white; border-radius: 9999px; padding: 8px 16px; font-weight: 500; margin-top: 8px; transition: transform 0.2s; width: 100%; }
        .save-btn:active { transform: scale(0.95); }
        .couple-space-card { background-color: white; border-radius: 24px; padding: 16px; margin-bottom: 16px; box-shadow: 0 5px 15px rgba(255, 182, 193, 0.2); }
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
    </style>
    <script src="database.js"></script>
</head>
<body>

    <div class="mobile-container">
        <div class="screen">
            <div class="dynamic-island"></div>
            <div class="content-wrapper" style="padding-top: 30%;">
                <div class="time-and-date"><div id="time" class="time"></div><div id="date" class="date"></div></div>
                <div class="home-content">
                    <div class="app-grid">
                        <div class="app-icon" data-app="chat"><div class="app-icon-img">ğŸ’¬</div><span>520</span></div>
                        <div class="app-icon" data-app="couple-space"><div class="app-icon-img">â¤ï¸</div><span>å¿ƒè·³åŒé¢‘ä¸­</span></div> <!-- ğŸŸ¢ æ›´æ–°ï¼šæ”¹å -->
                        <div class="app-icon" data-app="world-book"><div class="app-icon-img">ğŸ“–</div><span>ä¸–ç•Œä¹¦</span></div>
                        <div class="app-icon" data-app="check-phone"><div class="app-icon-img">ğŸ“±</div><span>æŸ¥æ‰‹æœº</span></div>
                    </div>
                    <div class="love-widget" style="height: 135px;">
                        <div class="avatars">
                            <label for="avatar1-upload" class="avatar-placeholder" id="avatar1-preview">å¤´åƒ1</label><input type="file" id="avatar1-upload" accept="image/*" class="hidden">
                            <label for="avatar2-upload" class="avatar-placeholder" id="avatar2-preview">å¤´åƒ2</label><input type="file" id="avatar2-upload" accept="image/*" class="hidden">
                        </div>
                        <div class="days-text">å°æƒ…ä¾£æ‹çˆ±ing</div><div id="love-days" class="days-count">...</div>
                    </div>
                </div>
            </div>
            <div class="dock backdrop-blur">
                <div class="app-icon" data-app="api-settings"><div class="app-icon-img">âš™ï¸</div><span>API</span></div>
                <div class="app-icon" data-app="phone"><div class="app-icon-img">ğŸ“</div><span>é€šè¯</span></div>
                <div class="app-icon" data-app="album"><div class="app-icon-img">ğŸ–¼ï¸</div><span>ç›¸å†Œ</span></div>
                <div class="app-icon" data-app="settings"><div class="app-icon-img">ğŸ”§</div><span>è®¾ç½®</span></div>
            </div>
        </div>
        
        <div id="chat-page" class="app-page"></div>
        <div id="world-book-page" class="app-page"></div>
        <div id="couple-space-page" class="app-page"></div>
        <div id="check-phone-page" class="app-page"></div>
        <div id="api-settings-page" class="app-page"></div>
        <div id="phone-page" class="app-page"></div>
        <div id="album-page" class="app-page"></div>
        <div id="settings-page" class="app-page"></div>
        <div id="ai-character-setup-page" class="app-page"></div>
        <div id="world-book-edit-page" class="app-page"></div>
        <div id="app-home-indicator" class="home-indicator" style="display: none;"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const timeEl = document.getElementById('time');
            const dateEl = document.getElementById('date');
            function updateTime() {
                const now = new Date();
                timeEl.textContent = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
                dateEl.textContent = now.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric', weekday: 'long' });
            }
            updateTime(); setInterval(updateTime, 1000);

            // --- æ¨¡æ¿å†…å®¹ ---
            const appContents = {
                chat: `
                    <div class="app-header-520"><span class="close-btn-520 close-btn">ä¸»é¡µ</span><h2 class="title" id="chat-title">èŠå¤©</h2><span class="add-btn-520" id="add-contact-btn" style="display: none;">+</span></div>
                    <div class="app-content-520-wrapper">
                        <div id="page-200" class="page-content-520"></div>
                        <div id="page-201" class="page-content-520 active"></div>
                        <div id="page-202" class="page-content-520"></div>
                        <div id="page-me" class="page-content-520"></div>
                    </div>
                    <div class="bottom-nav-520">
                        <div class="nav-item-520" data-page="200"><span class="icon">ğŸ’¬</span><span>200</span></div>
                        <div class="nav-item-520 active" data-page="201"><span class="icon">ğŸ‘¥</span><span>201</span></div>
                        <div class="nav-item-520" data-page="202"><span class="icon">â­•ï¸</span><span>202</span></div>
                        <div class="nav-item-520" data-page="me"><span class="icon">ğŸ‘¤</span><span>æˆ‘</span></div>
                    </div>
                `,
                'couple-space': `
                    <div class="app-header"><span class="text-pink-500 cursor-pointer close-btn">ä¸»é¡µ</span><h2 class="font-bold">å¿ƒè·³åŒé¢‘ä¸­</h2><span class="w-10"></span></div>
                    <div class="app-content p-4 bg-pink-50/50 overflow-y-auto">
                        <div class="couple-space-card text-center"><p class="text-gray-500">æˆ‘ä»¬å·²ç»åœ¨ä¸€èµ·</p><p id="days-together" class="text-4xl font-bold text-pink-500 my-2">...</p><p class="text-gray-500">å¤©</p></div>
                        <div class="couple-space-card"><h3 class="font-bold mb-2">ğŸ’Œ å†™ç»™TAçš„æƒ…ä¹¦</h3><textarea id="love-letter-textarea" class="w-full h-24 p-2 border rounded-lg" placeholder="å†™ä¸‹ä½ çš„ç”œè¨€èœœè¯­..."></textarea><button id="save-love-letter" class="mt-2 w-full bg-pink-500 text-white py-2 rounded-lg">ä¿å­˜æƒ…ä¹¦</button></div>
                    </div>
                `,
                'world-book': `
                    <div class="app-header-520"><span class="close-btn-520 close-btn">ä¸»é¡µ</span><h2 class="title">ä¸–ç•Œä¹¦</h2><span class="add-btn-520" id="add-world-book-btn">+</span></div>
                    <div class="app-content p-0" id="world-book-list" style="background: #f7f7f7;"></div>
                `,
                'api-settings': `
                    <div class="app-header"><span class="text-purple-500 cursor-pointer close-btn">ä¸»é¡µ</span><h2 class="font-bold">API è®¾ç½®</h2><span class="w-10"></span></div>
                    <div class="app-content p-5">
                        <div class="form-group"><label>æ¨¡å‹å¹³å°</label><select id="api-platform" class="w-full p-2 border rounded-lg"><option value="openai">OpenAI</option><option value="gemini">Gemini</option><option value="MyAPI">MyAPI</option></select></div>
                        <div class="form-group"><label>API æ¥å£åœ°å€</label><input type="text" id="api-endpoint" placeholder="æ¥å£åœ°å€ (ä¾‹å¦‚ https://api.openai.com/v1)"></div>
                        <div class="form-group"><label>API å¯†é’¥</label><input type="password" id="api-key" placeholder="API Key"></div>
                        <!-- ğŸŸ¢ æ¢å¤ï¼šåŒ…å«è·å–æŒ‰é’®çš„å®Œæ•´æ¨¡å‹åŒºåŸŸ -->
                        <div class="form-group">
                            <label>æ¨¡å‹</label>
                            <div class="flex gap-2">
                                <select id="api-model" class="w-full p-2 border rounded-lg bg-white hidden"></select>
                                <input type="text" id="api-model-custom" placeholder="è¾“å…¥æ¨¡å‹åç§°" class="w-full p-2 border rounded-lg bg-white">
                                <button id="fetch-models-btn" class="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition" title="è·å–æ¨¡å‹åˆ—è¡¨">ğŸ”„</button>
                            </div>
                        </div>
                        <button id="save-api-settings" class="mt-4 w-full bg-purple-500 text-white py-2 rounded-lg">ä¿å­˜è®¾ç½®</button>
                    </div>
                `,
                'settings': `
                    <div class="app-header"><span class="text-gray-600 cursor-pointer close-btn">ä¸»é¡µ</span><h2 class="font-bold">ç³»ç»Ÿè®¾ç½®</h2><span class="w-10"></span></div>
                    <div class="app-content p-5">
                        <div class="settings-item"><div><h3 class="font-bold">æ›´æ¢å£çº¸</h3><div class="wallpaper-options"><label for="wallpaper-upload" class="cursor-pointer border-2 border-dashed border-gray-300 rounded-lg w-16 h-20 flex items-center justify-center"><div id="wallpaper-preview-container" class="wallpaper-preview w-full h-full bg-cover bg-center rounded-lg">+</div></label><input type="file" id="wallpaper-upload" accept="image/*" class="hidden"></div><button id="save-wallpaper-btn" class="save-btn">ç¡®è®¤ä¿®æ”¹</button></div></div>
                        <div class="settings-item"><div><h3 class="font-bold">æ›´æ¢åº”ç”¨å›¾æ ‡</h3><div id="app-icon-list" class="space-y-2 mt-2"></div><button id="save-icons-btn" class="save-btn">ç¡®è®¤ä¿®æ”¹</button></div></div>
                        <div class="settings-item"><button id="reset-settings-btn" class="w-full bg-red-500 text-white py-2 rounded-lg">é‡ç½®æ‰€æœ‰è®¾ç½®</button></div>
                    </div>
                `,
                'ai-character-setup': `
                    <div class="app-header"><span class="text-black cursor-pointer ml-3" id="back-to-contacts" style="font-size: 28px; width: 40px;">â€¹</span><h2 class="font-bold text-lg">è”ç³»äºº</h2><span class="w-12"></span></div>
                    <div class="app-content p-4 pb-24" style="background:#f2f2f7; overflow-y: auto;">
                        <input type="hidden" id="ai-contact-id">
                        <div class="bg-white rounded-xl p-4 mb-4 shadow-sm">
                            <h3 class="font-bold text-gray-800 mb-3 border-l-4 border-blue-500 pl-2">æ ¸å¿ƒ</h3>
                            <div class="flex items-start gap-4 mb-4"><label for="ai-avatar-upload" class="w-20 h-20 rounded-2xl bg-gray-100 flex items-center justify-center text-3xl cursor-pointer overflow-hidden border border-gray-200"><img id="ai-avatar-preview" src="" class="hidden w-full h-full object-cover"><span id="ai-avatar-emoji">ğŸ“·</span></label><input type="file" id="ai-avatar-upload" class="hidden" accept="image/*"><div class="flex-1 space-y-2"><div><label class="text-xs text-gray-500">å§“å</label><input type="text" id="ai-name" class="w-full border-b border-gray-200 py-1"></div><div><label class="text-xs text-gray-500">å¤‡æ³¨</label><input type="text" id="ai-notes" class="w-full border-b border-gray-200 py-1"></div></div></div>
                            <div><label class="text-xs text-gray-500">äººè®¾</label><textarea id="ai-persona" rows="3" class="w-full mt-1 p-2 bg-gray-50 rounded-lg text-sm border-none resize-none"></textarea></div>
                        </div>
                        <div class="bg-white rounded-xl p-4 mb-4 shadow-sm">
                            <h3 class="font-bold text-gray-800 mb-3 border-l-4 border-green-500 pl-2">è®°å¿†</h3>
                            <div class="mb-3"><label class="text-sm font-medium">è®°å¿†æ•°</label><input type="number" id="ai-context-limit" value="10" class="float-right w-16 text-center border rounded bg-gray-50"></div>
                            <div class="mb-3"><label class="text-sm font-medium block mb-1">ä¸–ç•Œä¹¦</label><select id="ai-world-book-select" class="w-full p-2 bg-gray-50 rounded border border-gray-200 text-sm"><option value="">(æ— )</option></select></div>
                            <div><label class="text-sm font-medium block mb-1">æ‰‹åŠ¨è®°å¿†</label><textarea id="ai-manual-memory" rows="2" class="w-full p-2 bg-gray-50 rounded-lg text-sm resize-none"></textarea></div>
                        </div>
                        <div class="bg-white rounded-xl p-4 mb-6 shadow-sm">
                            <h3 class="font-bold text-gray-800 mb-3 border-l-4 border-purple-500 pl-2">æ¨¡å¼</h3>
                            <div class="flex justify-between items-center mb-4"><span class="text-sm font-medium">çº¿ä¸‹æ¨¡å¼</span><div class="relative inline-block w-10 mr-2"><input type="checkbox" id="mode-offline" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/><label for="mode-offline" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label></div></div>
                            <div class="flex justify-between items-center"><span class="text-sm font-medium">å¿ƒå£°æ¨¡å¼</span><div class="relative inline-block w-10 mr-2"><input type="checkbox" id="mode-thoughts" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/><label for="mode-thoughts" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label></div></div>
                        </div>
                        <div class="space-y-3"><button id="ai-save-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl">ä¿å­˜</button><div class="flex gap-3"><button id="ai-chat-btn" class="flex-1 bg-white text-green-600 font-bold py-3 rounded-xl border hidden">èŠå¤©</button><button id="ai-delete-btn" class="flex-1 bg-white text-red-500 font-bold py-3 rounded-xl border hidden">åˆ é™¤</button></div></div>
                    </div>
                `
            };

            // --- åŠŸèƒ½æ¨¡å—é€»è¾‘ ---

            function setupSettingsApp(appPage) {
                const screen = document.querySelector('.screen');
                const wallpaperUpload = appPage.querySelector('#wallpaper-upload');
                const preview = appPage.querySelector('#wallpaper-preview-container');
                const appIconList = appPage.querySelector('#app-icon-list');
                let tempUrl = null; const tempIcons = {};

                const savedWp = localStorage.getItem('customWallpaper');
                if(savedWp) preview.style.backgroundImage = `url(${savedWp})`;

                wallpaperUpload.onchange = (e) => {
                    const f = e.target.files[0];
                    if(f) { const r = new FileReader(); r.onload = (evt) => { tempUrl = evt.target.result; preview.style.backgroundImage = `url(${tempUrl})`; preview.textContent=''; }; r.readAsDataURL(f); }
                };
                appPage.querySelector('#save-wallpaper-btn').onclick = () => { if(tempUrl){ screen.style.backgroundImage = `url(${tempUrl})`; localStorage.setItem('customWallpaper', tempUrl); alert('å£çº¸å·²ä¿å­˜'); }};
                appPage.querySelector('#reset-settings-btn').onclick = () => { if(confirm('é‡ç½®æ‰€æœ‰æ•°æ®ï¼Ÿ')) { localStorage.clear(); location.reload(); }};

                // ğŸŸ¢ ä¿®å¤ï¼šæ­£ç¡®çš„ App ä¸­æ–‡åæ˜ å°„
                const appNameMap = {
                    'chat': '520',
                    'couple-space': 'å¿ƒè·³åŒé¢‘ä¸­',
                    'world-book': 'ä¸–ç•Œä¹¦',
                    'check-phone': 'æŸ¥æ‰‹æœº',
                    'api-settings': 'API',
                    'phone': 'é€šè¯',
                    'album': 'ç›¸å†Œ',
                    'settings': 'è®¾ç½®'
                };

                const apps = Object.keys(appNameMap);
                appIconList.innerHTML = apps.map(id => {
                    const saved = localStorage.getItem(`icon_${id}`);
                    // ğŸŸ¢ ä¿®å¤ï¼šæœªè®¾ç½®æ—¶æ˜¾ç¤ºè™šçº¿è¾¹æ¡†
                    return `<div class="flex justify-between items-center"><div class="flex items-center gap-2"><div class="icon-style-preview ${saved?'':'dashed-border'}" id="icon-prev-${id}" style="${saved?`background-image:url(${saved});border:1px solid #ccc`:''}">${saved?'':'+'}</div><span>${appNameMap[id]}</span></div><label class="bg-pink-400 text-white text-xs px-2 py-1 rounded-full cursor-pointer">ä¿®æ”¹<input type="file" data-id="${id}" class="hidden icon-up" accept="image/*"></label></div>`;
                }).join('');

                appPage.addEventListener('change', (e) => {
                    if(e.target.classList.contains('icon-up')) {
                        const f = e.target.files[0]; const id = e.target.dataset.id;
                        if(f){ const r = new FileReader(); r.onload=(evt)=>{ tempIcons[id]=evt.target.result; const p=document.getElementById(`icon-prev-${id}`); p.style.backgroundImage=`url(${evt.target.result})`; p.textContent=''; p.classList.remove('dashed-border'); p.style.border='1px solid #ccc'; }; r.readAsDataURL(f); }
                    }
                });
                appPage.querySelector('#save-icons-btn').onclick = () => {
                    Object.keys(tempIcons).forEach(id => { localStorage.setItem(`icon_${id}`, tempIcons[id]); const iconEl = document.querySelector(`.app-icon[data-app="${id}"] .app-icon-img`); if(iconEl){ iconEl.style.backgroundImage=`url(${tempIcons[id]})`; iconEl.style.backgroundSize='cover'; iconEl.textContent=''; }});
                    alert('å›¾æ ‡å·²æ›´æ–°');
                };
            }

            function setupApiSettingsApp(appPage) {
                const platform = appPage.querySelector('#api-platform');
                const endpoint = appPage.querySelector('#api-endpoint');
                const key = appPage.querySelector('#api-key');
                const modelSelect = appPage.querySelector('#api-model');
                const modelCustom = appPage.querySelector('#api-model-custom');
                const fetchBtn = appPage.querySelector('#fetch-models-btn');
                
                platform.value = localStorage.getItem('apiPlatform') || 'openai';
                endpoint.value = localStorage.getItem('apiEndpoint') || '';
                key.value = localStorage.getItem('apiKey') || '';
                modelCustom.value = localStorage.getItem('apiModel') || '';

                // ğŸŸ¢ ä¿®å¤ï¼šè°ƒç”¨å¤–éƒ¨ ApiHandler è·å–æ¨¡å‹
                fetchBtn.onclick = async () => {
                    if (typeof ApiHandler === 'undefined') return alert('è¯·ç¡®ä¿ api_handler.js å·²æ­£ç¡®åŠ è½½');
                    const p = platform.value;
                    const ep = endpoint.value;
                    const k = key.value;
                    if(!k) return alert('è¯·è¾“å…¥API Key');

                    fetchBtn.textContent = '...';
                    try {
                        const models = await ApiHandler.fetchModels(p, ep, k);
                        if(models.length) {
                            modelSelect.innerHTML = models.map(m => `<option value="${m}">${m}</option>`).join('');
                            modelSelect.classList.remove('hidden');
                            modelCustom.classList.add('hidden');
                            modelSelect.onchange = () => modelCustom.value = modelSelect.value;
                            if(!modelCustom.value) modelCustom.value = models[0];
                            alert(`æˆåŠŸè·å– ${models.length} ä¸ªæ¨¡å‹`);
                        } else {
                            throw new Error('æœªæ‰¾åˆ°æ¨¡å‹æ•°æ®');
                        }
                    } catch (e) {
                        console.error(e);
                        alert('è·å–å¤±è´¥: ' + e.message);
                    }
                    fetchBtn.textContent = 'ğŸ”„';
                };

                appPage.querySelector('#save-api-settings').onclick = () => {
                    localStorage.setItem('apiPlatform', platform.value);
                    localStorage.setItem('apiEndpoint', endpoint.value);
                    localStorage.setItem('apiKey', key.value);
                    localStorage.setItem('apiModel', modelCustom.value);
                    alert('APIé…ç½®å·²ä¿å­˜');
                };
            }

            function setupCoupleSpaceApp(appPage) {
                const dayEl = appPage.querySelector('#days-together');
                const start = new Date('2023-01-01');
                dayEl.textContent = Math.ceil(Math.abs(new Date() - start) / (86400000));
                
                const letter = appPage.querySelector('#love-letter-textarea');
                letter.value = localStorage.getItem('loveLetter') || '';
                appPage.querySelector('#save-love-letter').onclick = () => { localStorage.setItem('loveLetter', letter.value); alert('æƒ…ä¹¦å·²ä¿å­˜'); };
            }

            function setupWorldBookApp(appPage) {
                const addBtn = appPage.querySelector('#add-world-book-btn');
                const listEl = appPage.querySelector('#world-book-list');
                const render = () => {
                    const books = JSON.parse(localStorage.getItem('m-tea-world-books-list') || '[]');
                    if(books.length===0) listEl.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-400 mt-20"><span style="font-size:40px;">ğŸ“–</span><p>æš‚æ— ä¸–ç•Œä¹¦</p></div>`;
                    else listEl.innerHTML = `<div class="divide-y divide-gray-200 bg-white mt-4 border-t border-b">${books.map(b => `<div class="p-4 flex justify-between items-center cursor-pointer hover:bg-gray-50 wb-item" data-id="${b.id}"><div class="font-medium text-lg">${b.name}</div><div class="text-gray-400">â€º</div></div>`).join('')}</div>`;
                    appPage.querySelectorAll('.wb-item').forEach(i => i.onclick = () => edit(i.dataset.id));
                };
                const edit = (id) => {
                    let p = document.getElementById('world-book-edit-page');
                    if(!p.innerHTML) p.innerHTML = `<div class="app-header-520"><span class="close-btn-520" id="wb-no">å–æ¶ˆ</span><h2 class="title">ç¼–è¾‘</h2><span class="add-btn-520" id="wb-yes" style="font-size:16px;color:#07c160;font-weight:bold;">å®Œæˆ</span></div><div class="app-content p-4" style="background:#f2f2f7;"><input type="hidden" id="wb-id"><div class="bg-white rounded-lg p-2 mb-4"><input id="wb-name" class="w-full text-lg font-bold p-2 focus:outline-none" placeholder="ä¹¦å"></div><div class="bg-white rounded-lg p-2 flex-grow h-64"><textarea id="wb-c" class="w-full h-full p-2 resize-none focus:outline-none" placeholder="è®¾å®š..."></textarea></div><button id="wb-del" class="w-full mt-4 bg-white text-red-500 py-3 rounded-lg font-bold">åˆ é™¤</button></div>`;
                    const iId=p.querySelector('#wb-id'), iN=p.querySelector('#wb-name'), iC=p.querySelector('#wb-c'), del=p.querySelector('#wb-del');
                    iId.value=id||''; iN.value=''; iC.value=''; del.style.display=id?'block':'none';
                    if(id){ const b=JSON.parse(localStorage.getItem('m-tea-world-books-list')||'[]').find(x=>x.id===id); if(b){iN.value=b.name;iC.value=b.content;} }
                    p.querySelector('#wb-no').onclick=()=>{p.classList.remove('active');p.style.zIndex='200';};
                    p.querySelector('#wb-yes').onclick=()=>{
                        if(!iN.value)return; let bs=JSON.parse(localStorage.getItem('m-tea-world-books-list')||'[]');
                        const nb={id:iId.value||`wb_${Date.now()}`,name:iN.value,content:iC.value};
                        if(iId.value){const idx=bs.findIndex(x=>x.id===iId.value);if(idx>-1)bs[idx]=nb;}else bs.push(nb);
                        localStorage.setItem('m-tea-world-books-list',JSON.stringify(bs)); render(); p.classList.remove('active');
                    };
                    p.querySelector('#wb-del').onclick=()=>{if(confirm('åˆ é™¤?')){let bs=JSON.parse(localStorage.getItem('m-tea-world-books-list')||'[]');bs=bs.filter(x=>x.id!==iId.value);localStorage.setItem('m-tea-world-books-list',JSON.stringify(bs));render();p.classList.remove('active');}};
                    p.style.zIndex='350'; p.classList.add('active');
                };
                addBtn.onclick = () => edit(null);
                render();
            }

            function setupChatApp(appPage) {
                appPage.classList.add('app-page-520');
                const navs = appPage.querySelectorAll('.nav-item-520');
                const pages = appPage.querySelectorAll('.page-content-520');
                const title = appPage.querySelector('#chat-title');
                const addBtn = appPage.querySelector('#add-contact-btn');
                
                const openChat = (id) => {
                    const c = DB.getContact(id); if(!c) return;
                    let p = appPage.querySelector('#conversation-page');
                    if(!p) { p=document.createElement('div'); p.id='conversation-page'; p.className='chat-conversation-page'; p.style.cssText='position:absolute;top:0;left:0;width:100%;height:100%;background:#efeff4;z-index:50;display:flex;flex-direction:column;'; appPage.appendChild(p); }
                    p.innerHTML = `<div class="app-header-520"><span class="close-btn-520" id="chat-back" style="font-size:16px;">â€¹ èŠå¤©</span><h2 class="title">${c.notes||c.name}</h2><span class="add-btn-520" id="chat-more" style="font-size:20px;">â€¢â€¢â€¢</span></div><div class="chat-messages" id="chat-box" style="${c.chatBackground?`background:url(${c.chatBackground}) center/cover no-repeat`:''}"></div><div class="chat-footer"><div class="chat-input-bar"><div class="chat-btn-icon" id="voice-sw">ğŸ¤</div><input type="text" class="chat-input-field" id="chat-in"><div class="chat-voice-btn" id="voice-btn" style="display:none;">æŒ‰ä½ è¯´è¯</div><div class="chat-btn-icon" id="emoji-btn">â˜º</div><div class="chat-btn-icon" id="plus-btn">+</div><button class="ai-reply-btn" id="ai-btn">AI</button></div><div class="plus-panel" id="plus-p"><div class="plus-grid"><div class="plus-item" id="p-trans"><div class="plus-icon-box" style="color:#fa9d3b;">ï¿¥</div><div class="plus-label">è½¬è´¦</div></div><div class="plus-item" id="p-call"><div class="plus-icon-box" style="color:#07c160;">ğŸ“¹</div><div class="plus-label">é€šè¯</div></div><div class="plus-item" id="p-pic"><div class="plus-icon-box" style="color:#10aeff;">ğŸ–¼ï¸</div><div class="plus-label">ç…§ç‰‡</div></div><div class="plus-item" id="p-loc"><div class="plus-icon-box" style="color:#888;">ğŸ“</div><div class="plus-label">ä½ç½®</div></div><div class="plus-item" id="p-cam"><div class="plus-icon-box" style="color:#000;">ğŸ“·</div><div class="plus-label">æ‹æ‘„</div></div></div></div></div> <div class="chat-details-page" id="chat-sets"><div class="app-header-520"><span class="close-btn-520" id="set-back">â€¹</span><h2 class="title">è¯¦æƒ…</h2></div><div class="app-content p-0"><div class="bg-white mt-2"><div class="p-4 flex flex-col items-center"><div class="w-16 h-16 rounded-lg bg-gray-200 mb-2 flex items-center justify-center text-3xl overflow-hidden">${c.avatar}</div><div class="text-sm">${c.name}</div></div></div><div class="bg-white mt-2"><div class="p-3 border-b flex justify-between" id="set-pat"><span>æ‹ä¸€æ‹</span><span>â€º</span></div><div class="p-3 border-b flex justify-between" id="set-bg"><span>èƒŒæ™¯</span><span>â€º</span></div></div><div class="bg-white mt-2"><div class="p-3 text-red-500 text-center" id="set-clr">æ¸…ç©ºè®°å½•</div></div></div></div>`;
                    
                    const box=p.querySelector('#chat-box'), inp=p.querySelector('#chat-in'), plus=p.querySelector('#plus-p');
                    const history = DB.getChatById(id) || [];
                    const render = () => {
                        box.innerHTML = history.map(m => {
                            if(m.sender==='system') return `<div class="message-timestamp">${m.text}</div>`;
                            const me = m.sender==='me';
                            let body = m.text;
                            if(m.type==='image') body=`<img src="${m.content}">`;
                            if(m.type==='voice') body=`${me?'':`<span style="color:red;font-size:8px;">â—</span>`} ğŸ”Š ${m.duration}"`;
                            if(m.type==='transfer') body=`<div class="flex items-center gap-2"><div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">ï¿¥</div><div><div>ï¿¥${m.amount}</div><div class="text-xs opacity-70">${m.note}</div></div></div>`;
                            if(m.type==='location') body=`<div class="font-bold text-sm text-black">${m.content}</div><div class="text-xs text-gray-500">ä½ç½®</div><div class="w-full h-16 bg-gray-200 mt-1 flex items-center justify-center">ğŸ—ºï¸</div>`;
                            
                            // ğŸŸ¢ ä¿®å¤ï¼šå¤´åƒé¡ºåºè°ƒæ•´ï¼Œç¡®ä¿è‡ªå·±å¤´åƒåœ¨å³
                            // CSS å·²ç»è®¾ç½® .message-row.sent { flex-direction: row-reverse; }
                            // æ— è®ºè°å‘æ¶ˆæ¯ï¼ŒHTMLç»“æ„ç»Ÿä¸€ä¸º [å¤´åƒ] [æ°”æ³¡]
                            // CSS ä¼šè‡ªåŠ¨å¤„ç†å·¦å³ä½ç½®
                            const avatar = me ? `<div class="message-avatar">ğŸ‘¤</div>` : `<div class="message-avatar">${c.avatar}</div>`;
                            return `<div class="message-row ${me?'sent':'received'}">${avatar}<div class="message-bubble ${me?'sent':'received'} ${m.type||''}">${body}</div></div>`;
                        }).join('');
                        box.scrollTop = box.scrollHeight;
                    };
                    render();
                    const send = (msg) => { DB.addMessage(id, msg); history.push(msg); render(); };
                    
                    p.querySelector('#chat-back').onclick=()=>{p.remove(); go('200');};
                    p.querySelector('#btn-voice-toggle')?.addEventListener('click', function() { /* ... */ }); 
                    p.querySelector('#voice-sw').onclick=(e)=>{ const v=e.target.textContent==='ğŸ¤'; e.target.textContent=v?'âŒ¨':'ğŸ¤'; inp.style.display=v?'none':'block'; p.querySelector('#voice-btn').style.display=v?'block':'none'; };
                    p.querySelector('#voice-btn').onclick=()=>{ const t=prompt('è¯­éŸ³å†…å®¹'); if(t) send({id:`m_${Date.now()}`,sender:'me',type:'voice',text:t,duration:Math.ceil(t.length/2),time:new Date()}); };
                    inp.onkeypress=(e)=>{if(e.key==='Enter'&&inp.value){send({id:`m_${Date.now()}`,sender:'me',type:'text',text:inp.value,time:new Date()});inp.value='';}};
                    p.querySelector('#plus-btn').onclick=()=>{plus.classList.toggle('open'); setTimeout(()=>box.scrollTop=box.scrollHeight,210);};
                    p.querySelector('#p-trans').onclick=()=>{const a=prompt('é‡‘é¢');if(a) send({id:`m_${Date.now()}`,sender:'me',type:'transfer',amount:a,note:'è½¬è´¦',time:new Date()});};
                    p.querySelector('#p-pic').onclick=()=>{const d=prompt('å›¾ç‰‡æè¿°');if(d) send({id:`m_${Date.now()}`,sender:'me',type:'image',content:'https://images.unsplash.com/photo-1518020382113-a7e8fc38eac9?w=300',text:d,time:new Date()});};
                    p.querySelector('#p-loc').onclick=()=>{const l=prompt('ä½ç½®');if(l) send({id:`m_${Date.now()}`,sender:'me',type:'location',content:l,time:new Date()});};
                    
                    p.querySelector('#ai-btn').onclick=async ()=>{
                        const lastMsg = history[history.length-1];
                        if(lastMsg && lastMsg.sender === 'me') {
                             const apiKey = localStorage.getItem('apiKey');
                             if (apiKey && typeof ApiHandler !== 'undefined') {
                                // ğŸŸ¢ ä¿®å¤ï¼šä½¿ç”¨å¤–éƒ¨ ApiHandler å‘é€æ¶ˆæ¯
                                const btn = p.querySelector('#ai-btn');
                                btn.textContent = '...';
                                try {
                                    const p = localStorage.getItem('apiPlatform')||'openai';
                                    const ep = localStorage.getItem('apiEndpoint')||'';
                                    const m = localStorage.getItem('apiModel')||'gpt-3.5-turbo';
                                    
                                    const payload = ApiHandler.generateChatPayload(p, ep, apiKey, m, lastMsg.text);
                                    const res = await fetch(payload.url, payload.options);
                                    if(!res.ok) throw new Error(`HTTP ${res.status}`);
                                    
                                    const data = await res.json();
                                    const reply = ApiHandler.parseChatResponse(p, data);
                                    
                                    if(reply) send({id:`r_${Date.now()}`,sender:'ai',text:reply,time:new Date()});
                                    else throw new Error('API è¿”å›ç©ºå†…å®¹');
                                    
                                } catch(e) { alert('API Error: '+e.message); }
                                btn.textContent = 'AI';
                             } else {
                                alert("è¯·å…ˆé…ç½®API Keyï¼Œå¹¶ç¡®ä¿ api_handler.js å·²åŠ è½½");
                             }
                        } else {
                            alert("è¯·å…ˆå‘ä¸€æ¡æ¶ˆæ¯");
                        }
                    };

                    const sets=p.querySelector('#chat-sets');
                    p.querySelector('#chat-more').onclick=()=>{sets.classList.add('active');};
                    p.querySelector('#set-back').onclick=()=>{sets.classList.remove('active');};
                    p.querySelector('#set-pat').onclick=()=>{const v=prompt('æ‹ä¸€æ‹å†…å®¹',c.nudge||'æ‹äº†æ‹æˆ‘');if(v){c.nudge=v;DB.saveContact(c);}};
                    p.querySelector('#set-bg').onclick=()=>{const v=prompt('èƒŒæ™¯URL');c.chatBackground=v;DB.saveContact(c);box.style.background=v?`url(${v}) center/cover`:''};
                    p.querySelector('#set-clr').onclick=()=>{if(confirm('æ¸…ç©º?')){DB.saveChats({...DB.getChats(),[id]:[]});history.length=0;render();sets.classList.remove('active');}};
                };

                const go = (pid) => {
                    navs.forEach(n => n.classList.toggle('active', n.dataset.page===pid));
                    pages.forEach(p => p.classList.toggle('active', p.id===`page-${pid}`));
                    title.textContent = {'200':'èŠå¤©','201':'é€šè®¯å½•','202':'æ­¤åˆ»','me':'æˆ‘'}[pid];
                    addBtn.style.display = pid==='201'?'block':'none';
                    
                    const el = document.getElementById(`page-${pid}`); el.innerHTML='';
                    if(pid==='200'){
                        const chats = Object.keys(DB.getChats()).map(id=>{
                            const ms=DB.getChatById(id); if(!ms.length)return null;
                            return {c:DB.getContact(id), m:ms[ms.length-1], id};
                        }).filter(x=>x&&x.c).sort((a,b)=>new Date(b.m.time)-new Date(a.m.time));
                        el.innerHTML = chats.map(x=>`<div class="chat-list-item" data-id="${x.id}"><div class="chat-list-avatar">${x.c.avatar}</div><div class="chat-list-info"><div class="flex justify-between"><span class="font-medium">${x.c.notes||x.c.name}</span><span class="text-xs text-gray-400">${new Date(x.m.time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span></div><div class="text-gray-500 text-sm truncate">${x.m.type==='image'?'[å›¾ç‰‡]':x.m.text}</div></div></div>`).join('');
                        el.querySelectorAll('.chat-list-item').forEach(i=>i.onclick=()=>openChat(i.dataset.id));
                    }
                    if(pid==='201'){
                        const cs = DB.getContacts();
                        el.innerHTML = cs.map(c=>`<div class="chat-list-item contact-item" data-id="${c.id}"><div class="chat-list-avatar">${c.avatar}</div><div class="font-medium">${c.notes||c.name}</div></div>`).join('');
                        el.querySelectorAll('.contact-item').forEach(i=>i.onclick=()=>{
                            const setup=document.getElementById('ai-character-setup-page');
                            if(!setup.innerHTML) setup.innerHTML=appContents['ai-character-setup'];
                            setupAiCharacterPage(setup, i.dataset.id, ()=>go('201'));
                            setup.classList.add('active');
                        });
                    }
                    if(pid==='202') el.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-300"><span>â­•ï¸</span><p>æœ‹å‹åœˆä¸ºç©º</p></div>`;
                    if(pid==='me') el.innerHTML = `<div class="me-page-container"><div class="bg-white p-6 flex items-center gap-4"><div class="w-16 h-16 bg-gray-200 rounded text-3xl flex items-center justify-center">ğŸ‘¤</div><div><div class="text-xl font-bold">æˆ‘</div><div class="text-gray-500 text-sm">ID: 5201314</div></div></div></div>`;
                };
                navs.forEach(n => n.onclick=()=>go(n.dataset.page));
                addBtn.onclick=()=>{
                    const setup=document.getElementById('ai-character-setup-page');
                    if(!setup.innerHTML) setup.innerHTML=appContents['ai-character-setup'];
                    setupAiCharacterPage(setup, null, ()=>go('201'));
                    setup.classList.add('active');
                };
                go('200');
            }

            function setupAiCharacterPage(appPage, contactId, onSaveCallback) {
                const backBtn = appPage.querySelector('#back-to-contacts');
                const saveBtn = appPage.querySelector('#ai-save-btn');
                const chatBtn = appPage.querySelector('#ai-chat-btn');
                const deleteBtn = appPage.querySelector('#ai-delete-btn');
                const idInput = appPage.querySelector('#ai-contact-id');
                const nameInput = appPage.querySelector('#ai-name');
                const notesInput = appPage.querySelector('#ai-notes');
                const personaInput = appPage.querySelector('#ai-persona');
                const contextLimitInput = appPage.querySelector('#ai-context-limit');
                const worldBookSelect = appPage.querySelector('#ai-world-book-select');
                const manualMemoryInput = appPage.querySelector('#ai-manual-memory');
                const offlineToggle = appPage.querySelector('#mode-offline');
                const thoughtsToggle = appPage.querySelector('#mode-thoughts');
                const avatarPreview = appPage.querySelector('#ai-avatar-preview');
                const avatarEmoji = appPage.querySelector('#ai-avatar-emoji');
                const avatarUpload = appPage.querySelector('#ai-avatar-upload');

                const worldBooks = JSON.parse(localStorage.getItem('m-tea-world-books-list') || '[]');
                worldBookSelect.innerHTML = '<option value="">(æ— )</option>' + worldBooks.map(wb => `<option value="${wb.id}">${wb.name}</option>`).join('');

                let currentAvatar = 'ğŸ¤–';
                avatarUpload.onchange = (e) => {
                    const file = e.target.files[0];
                    if(file){
                        const reader = new FileReader();
                        reader.onload = (evt) => {
                            currentAvatar = `<img src="${evt.target.result}" style="width:100%;height:100%;object-fit:cover;">`;
                            avatarPreview.src = evt.target.result;
                            avatarPreview.classList.remove('hidden');
                            avatarEmoji.classList.add('hidden');
                        };
                        reader.readAsDataURL(file);
                    }
                };

                idInput.value = contactId || '';
                nameInput.value = ''; notesInput.value = ''; personaInput.value = '';
                contextLimitInput.value = 10; worldBookSelect.value = ''; manualMemoryInput.value = '';
                offlineToggle.checked = false; thoughtsToggle.checked = false;
                avatarPreview.classList.add('hidden'); avatarEmoji.classList.remove('hidden');

                if (!contactId) {
                    chatBtn.style.display = 'none';
                    deleteBtn.style.display = 'none';
                } else {
                    chatBtn.style.display = 'block';
                    deleteBtn.style.display = 'block';
                    const contact = DB.getContact(contactId);
                    if (contact) {
                        nameInput.value = contact.name;
                        notesInput.value = contact.notes || '';
                        personaInput.value = contact.persona || '';
                        if(contact.memory) {
                            contextLimitInput.value = contact.memory.contextLimit || 10;
                            worldBookSelect.value = contact.memory.worldBookId || '';
                            manualMemoryInput.value = contact.memory.manual || '';
                        }
                        if(contact.mode) {
                            offlineToggle.checked = contact.mode.offline || false;
                            thoughtsToggle.checked = contact.mode.innerThoughts || false;
                        }
                        if(contact.avatar && contact.avatar.includes('img')) {
                             const src = contact.avatar.match(/src="([^"]*)"/)[1];
                             avatarPreview.src = src;
                             avatarPreview.classList.remove('hidden');
                             avatarEmoji.classList.add('hidden');
                             currentAvatar = contact.avatar;
                        }
                    }
                }

                saveBtn.onclick = () => {
                    if (!nameInput.value.trim()) return alert('è¯·è¾“å…¥å§“å');
                    const contactData = {
                        id: idInput.value || `contact_${Date.now()}`,
                        name: nameInput.value,
                        notes: notesInput.value,
                        avatar: currentAvatar,
                        persona: personaInput.value,
                        memory: {
                            contextLimit: contextLimitInput.value,
                            worldBookId: worldBookSelect.value,
                            manual: manualMemoryInput.value
                        },
                        mode: {
                            offline: offlineToggle.checked,
                            innerThoughts: thoughtsToggle.checked
                        }
                    };
                    DB.saveContact(contactData);
                    alert('ä¿å­˜æˆåŠŸ');
                    if(onSaveCallback) onSaveCallback();
                };
                
                chatBtn.onclick = () => {
                    const currentId = idInput.value;
                    const chats = DB.getChats();
                    if (!chats[currentId]) {
                        DB.addMessage(currentId, {
                            id: `msg_init_${Date.now()}`, sender: 'system', text: 'ä½ ä»¬å·²æˆä¸ºå¥½å‹ï¼Œå¼€å§‹èŠå¤©å§', time: new Date().toISOString()
                        });
                    }
                    appPage.classList.remove('active');
                    const chatApp = document.getElementById('chat-page');
                    const nav200 = chatApp.querySelector('.nav-item-520[data-page="200"]');
                    if(nav200) nav200.click();
                };

                deleteBtn.onclick = () => {
                    if (confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) {
                        DB.deleteContact(idInput.value);
                        if(onSaveCallback) onSaveCallback();
                        appPage.classList.remove('active');
                    }
                }
                
                backBtn.onclick = () => appPage.classList.remove('active');
            }

            function setupLoveWidget() {
                const loveDaysEl = document.getElementById('love-days');
                const avatar1Preview = document.getElementById('avatar1-preview');
                const avatar1Upload = document.getElementById('avatar1-upload');
                const avatar2Preview = document.getElementById('avatar2-preview');
                const avatar2Upload = document.getElementById('avatar2-upload');

                const loveStartDate = localStorage.getItem('loveStartDate');
                if (loveStartDate) {
                    const diffDays = Math.ceil(Math.abs(new Date() - new Date(loveStartDate)) / (1000 * 60 * 60 * 24));
                    loveDaysEl.textContent = diffDays;
                } else {
                    loveDaysEl.textContent = '1';
                }

                function setupAvatar(uploadEl, previewEl, storageKey) {
                    const savedAvatar = localStorage.getItem(storageKey);
                    if (savedAvatar) {
                        previewEl.style.backgroundImage = `url(${savedAvatar})`;
                        previewEl.textContent = '';
                    }
                    uploadEl.addEventListener('change', (event) => {
                        const file = event.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                previewEl.style.backgroundImage = `url(${e.target.result})`;
                                previewEl.textContent = '';
                                localStorage.setItem(storageKey, e.target.result);
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }
                setupAvatar(avatar1Upload, avatar1Preview, 'avatar1');
                setupAvatar(avatar2Upload, avatar2Preview, 'avatar2');
            }

            const appIcons = document.querySelectorAll('.app-icon');
            setupLoveWidget();
            
            appIcons.forEach(icon => {
                icon.addEventListener('click', (e) => {
                    const appId = icon.dataset.app;
                    const appPage = document.getElementById(`${appId}-page`);
                    const screen = document.querySelector('.screen');

                    if (appPage) {
                        if (!appPage.innerHTML) {
                            let content = appContents[appId] || `<div class="app-header"><span class="close-btn">ä¸»é¡µ</span><h2 class="font-bold">${icon.querySelector('span').textContent}</h2><span></span></div><div class="app-content p-5"><p>å¼€å‘ä¸­...</p></div>`;
                            appPage.innerHTML = content;
                            
                            if (appId === 'chat') setupChatApp(appPage);
                            else if (appId === 'world-book') setupWorldBookApp(appPage);
                            else if (appId === 'couple-space') setupCoupleSpaceApp(appPage);
                            else if (appId === 'api-settings') setupApiSettingsApp(appPage);
                            else if (appId === 'settings') setupSettingsApp(appPage);

                            const closeApp = () => {
                                if (appPage.classList.contains('closing')) return;
                                const iconRect = icon.getBoundingClientRect();
                                const screenRect = screen.getBoundingClientRect();
                                appPage.style.transformOrigin = `${((iconRect.left + iconRect.width / 2) - screenRect.left) / screenRect.width * 100}% ${((iconRect.top + iconRect.height / 2) - screenRect.top) / screenRect.height * 100}%`;
                                appPage.classList.add('closing');
                                document.getElementById('app-home-indicator').style.display = 'none';
                                appPage.addEventListener('animationend', () => appPage.classList.remove('active', 'closing'), { once: true });
                            };
                            appPage.querySelector('.close-btn').addEventListener('click', closeApp);
                            document.getElementById('app-home-indicator').addEventListener('click', closeApp);
                        }
                        
                        const iconRect = icon.getBoundingClientRect();
                        const screenRect = screen.getBoundingClientRect();
                        appPage.style.transformOrigin = `${((iconRect.left + iconRect.width / 2) - screenRect.left) / screenRect.width * 100}% ${((iconRect.top + iconRect.height / 2) - screenRect.top) / screenRect.height * 100}%`;
                        appPage.classList.add('active');
                        document.getElementById('app-home-indicator').style.display = 'block';
                    }
                });
            });
            
            const screen = document.querySelector('.screen');
            const savedWallpaper = localStorage.getItem('wallpaper') || 'https://images.unsplash.com/photo-1500964757637-c85e8a162699?q=80&w=2703&auto=format&fit=crop';
            screen.style.backgroundImage = `url('${savedWallpaper}')`;
        });
    </script>
    <script src="api_handler.js"></script>
</body>
</html>