<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>çœ èŒ¶æœº</title>
    <link rel="icon" href="Gemini_Generated_Image_9nxbzu9nxbzu9nxb.png?v=2" type="image/png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="çœ èŒ¶æœº">
    <link rel="apple-touch-icon" href="Gemini_Generated_Image_9nxbzu9nxbzu9nxb.png">
    <link rel="apple-touch-icon" sizes="180x180" href="Gemini_Generated_Image_9nxbzu9nxbzu9nxb.png">
    <link rel="apple-touch-icon" sizes="167x167" href="Gemini_Generated_Image_9nxbzu9nxbzu9nxb.png">
    <link rel="apple-touch-icon" sizes="152x152" href="Gemini_Generated_Image_9nxbzu9nxbzu9nxb.png">
    <link rel="apple-touch-icon" sizes="120x120" href="Gemini_Generated_Image_9nxbzu9nxbzu9nxb.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- æ ¸å¿ƒåŸºç¡€ --- */
        body { display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(180deg, #fff5f7 0%, #ffeaf0 100%); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; overflow: hidden; user-select: none; }
        .mobile-container { width: 360px; height: 640px; background-color: #ffffff; border-radius: 40px; box-shadow: 0 10px 30px rgba(255, 182, 193, 0.3); position: relative; overflow: hidden; transform: scale(0.95); border: 10px solid #000000; }
        .screen { width: 100%; height: 100%; border-radius: 30px; background-color: transparent; background-size: cover; background-position: center; position: relative; display: flex; flex-direction: column; padding-bottom: 20px; box-sizing: border-box; }
        .backdrop-blur { -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); }
        .dynamic-island { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 120px; height: 25px; background-color: #000; border-radius: 0 0 15px 15px; z-index: 300; pointer-events: none; }
        .time-and-date { text-align: center; color: white; z-index: 10; margin-bottom: 20px; }
        .time { font-size: 70px; font-weight: 600; }
        .date { font-size: 20px; font-weight: 400; }
        .home-indicator { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); width: 134px; height: 5px; background-color: rgba(0,0,0,0.4); border-radius: 2.5px; cursor: pointer; z-index: 310; }

        /* --- æ¡Œé¢å…ƒç´  --- */
        .home-content { display: flex; justify-content: center; padding: 20px 40px; column-gap: 15px; }
        .app-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .app-icon { display: flex; flex-direction: column; align-items: center; text-align: center; color: white; font-size: 12px; text-shadow: 0 1px 3px rgba(0,0,0,0.15); cursor: pointer; transition: transform 0.2s; flex-shrink: 0; aspect-ratio: 1 / 1; width: 60px; height: 60px; }
        .app-icon:active { transform: scale(0.9); }
        .app-icon-img { width: 60px; height: 60px; background-color: rgba(255,255,255,0.4); -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); border-radius: 15px; margin-bottom: 5px; display: flex; justify-content: center; align-items: center; font-size: 16px; box-shadow: 0 4px 10px rgba(255,182,193,0.1); aspect-ratio: 1 / 1; flex-shrink: 0; object-fit: cover; overflow: hidden; }
        .dock .app-icon-img { background-color: transparent; -webkit-backdrop-filter: none; backdrop-filter: none; }
        .dock .app-icon-img { background-color: transparent; -webkit-backdrop-filter: none; backdrop-filter: none; }
        .love-widget { grid-column: span 2; grid-row: span 2; background-color: rgba(255,255,255,0.4); -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); border-radius: 22px; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.15); aspect-ratio: 1/1; flex-shrink: 0; }
        .love-widget .avatars { display: flex; gap: -15px; margin-bottom: 8px; }
        .love-widget .avatar-placeholder { width: 40px; height: 40px; border-radius: 50%; background-color: rgba(255,255,255,0.3); border: 2px solid white; background-size: cover; background-position: center; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 10px; color: rgba(255,255,255,0.7); }
        .love-widget .days-count { font-size: 24px; font-weight: 600; }
        #tea-widget { width: 140px !important; height: 140px !important; aspect-ratio: 1 / 1 !important; flex-shrink: 0 !important; border-radius: 2rem; margin: 0 auto; }
        .dock { position: absolute; bottom: 40px; left: 10px; right: 10px; height: 90px; background-color: rgba(255,255,255,0.5); border-radius: 34px; display: flex; justify-content: space-around; align-items: flex-start; padding: 6px 10px 16px; z-index: 20; }

        /* --- App å®¹å™¨ --- */
        .app-page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: #fffafb; z-index: 200; display: flex; flex-direction: column; box-sizing: border-box; opacity: 0; transform: scale(0.1); border-radius: 44px; pointer-events: none; transform-origin: center; }
        .app-page.active { pointer-events: auto; animation: open-app 0.5s cubic-bezier(0.45, 0, 0.1, 1) forwards; }
        .app-page.closing { animation: close-app 0.4s cubic-bezier(0.8, 0, 0.2, 1) forwards; }
        @keyframes open-app { from { opacity: 0; transform: scale(0.1); border-radius: 44px; } to { opacity: 1; transform: scale(1); border-radius: 0; } }
        @keyframes close-app { from { opacity: 1; transform: scale(1); border-radius: 0; } to { opacity: 0; transform: scale(0.1); border-radius: 44px; } }
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 45px 15px 15px; background-color: rgba(255, 255, 255, 0.9); border-bottom: 1px solid rgba(0,0,0,0.05); flex-shrink: 0; }
        .app-content { flex-grow: 1; overflow-y: auto; }

        /* --- 520 App åŸºç¡€æ¡†æ¶ --- */
        .app-header-520 { background-color: #fff; border-bottom: 1px solid #f0f0f0; padding-top: 30px; height: 80px; display: flex; align-items: center; justify-content: center; position: relative; z-index: 100; box-sizing: border-box;}
        .app-header-520 .title { font-size: 17px; font-weight: 600; color: #000; }
        .app-header-520 .close-btn-520, .app-header-520 .add-btn-520 { position: absolute; padding: 10px; font-size: 16px; cursor: pointer; color: #333; bottom: 10px; }
        .app-header-520 .close-btn-520 { left: 5px; }
        .app-header-520 .add-btn-520 { right: 5px; font-size: 20px; }
        
        .bottom-nav-520 { display: flex; justify-content: space-around; background-color: #f7f7f7; border-top: 1px solid #b2b2b2; padding-top: 6px; padding-bottom: 20px; flex-shrink: 0; z-index: 10; }
        .nav-item-520 { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: #8e8e93; cursor: pointer; }
        .nav-item-520.active { color: #007aff; }
        .nav-item-520 .icon { font-size: 20px; margin-bottom: 2px; }
        .page-content-520 { position: absolute; top: 0; left: 0; right: 0; bottom: 0; opacity: 0; pointer-events: none; overflow-y: auto; background-color: #fff; }
        .app-content-520-wrapper { flex: 1; position: relative; overflow: hidden; }
        .page-content-520.active { opacity: 1; pointer-events: auto; }

        /* --- åˆ—è¡¨ä¸èŠå¤© --- */
        .chat-list-item { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; background: #fff; margin:0; }
        .chat-list-avatar { width: 48px; height: 48px; border-radius: 6px; flex-shrink: 0; background-color: #e5e5e5; margin-right: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; overflow: hidden; }
        .chat-list-info { flex-grow: 1; overflow: hidden; }
        
        .chat-conversation-page { display: flex; flex-direction: column; background-color: #ededed; }
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; padding-bottom: 20px; }
        .message-timestamp {
            align-self: center;
            color: #b2b2b2;
            font-size: 11px;
            margin: 12px 0 8px 0;
            text-align: center;
            width: 100%;
        }
        
        .message-row { display: flex; margin-bottom: 12px; align-items: flex-start; width: 100%; }
        .message-row.received { flex-direction: row; }
        .message-row.received .message-avatar { margin-right: 10px; margin-left: 0; }
        .message-row.sent { flex-direction: row-reverse; }
        .message-row.sent .message-avatar { margin-left: 10px; margin-right: 0; }
        .message-avatar { width: 40px; height: 40px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 20px; background: #fff; flex-shrink: 0; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: pointer; }
        
        /* æ°”æ³¡æ–°æ ·å¼ */
        .message-bubble { border-radius: 18px; padding: 10px 14px; font-size: 16px; line-height: 1.5; color: #000; position: relative; max-width: 75%; transition: opacity 0.3s; word-wrap: break-word; }
        .message-bubble.sent { background-color: #fffae6; }
        .message-bubble.received { background-color: #fededf; }
        .message-bubble.quoting { opacity: 0.5; }
        .quote-content { display: block; font-size: 12px; color: #888; margin-bottom: 4px; border-left: 2px solid #ccc; padding-left: 6px; }

        .message-bubble.voice { display: flex; align-items: center; gap: 5px; cursor: pointer; min-width: 60px; }
        .message-bubble.image img { border-radius: 4px; max-width: 100%; display: block; }
        .message-bubble.transfer { background-color: #fa9d3b; color: white; padding: 15px; display: flex; flex-direction: column; min-width: 180px; }
        .message-bubble.location { background-color: #fff; padding: 5px; border: 1px solid #ddd; }

        /* åº•éƒ¨è¾“å…¥æ  */
        .chat-footer { background-color: #f7f7f7; border-top: 1px solid #dcdcdc; transition: padding-bottom 0.2s; position: relative; z-index: 20;}
        .chat-input-bar { display: flex; align-items: center; padding: 8px 10px; gap: 8px; min-height: 50px; }
        .chat-input-field { flex-grow: 1; border: none; padding: 8px 12px; border-radius: 18px; font-size: 16px; background: #fff; min-height: 36px; max-height: 100px; overflow-y: auto; }
        .chat-voice-btn { flex-grow: 1; text-align: center; padding: 8px; background: #fff; border-radius: 6px; font-weight: bold; font-size: 15px; border: 1px solid #ddd; cursor: pointer; user-select: none; }
        .chat-voice-btn:active { background: #dcdcdc; }
        
        .chat-action-btn {
            width: 36px; height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: transform 0.1s;
        }
        .chat-action-btn:active { transform: scale(0.9); }
        #voice-sw-btn { background-color: #ebf5ff; }
        #emoji-btn { background-color: #ceecfa; font-size: 20px; }
        #plus-btn { background-color: #e6f8f6; font-size: 22px; }
        #ai-btn { background-color: #aed5ff; color: white; font-size: 14px; font-weight: bold; }

        .wave-icon {
            position: relative;
            width: 24px;
            height: 24px;
            transform: translateX(-5px);
        }
        .wave-icon span {
            position: absolute;
            box-sizing: border-box;
            border: 2px solid #333;
            border-color: transparent #333 transparent transparent;
            border-radius: 50%;
        }
        .wave-icon span:nth-child(1) {
            width: 8px;
            height: 8px;
            top: 8px;
            left: 8px;
        }
        .wave-icon span:nth-child(2) {
            width: 14px;
            height: 14px;
            top: 5px;
            left: 5px;
        }
        .wave-icon span:nth-child(3) {
            width: 20px;
            height: 20px;
            top: 2px;
            left: 2px;
        }

        .plus-panel { height: 0; overflow: hidden; background: #f7f7f7; transition: height 0.2s; border-top: 1px solid #dcdcdc; }
        .plus-panel.open { height: 180px; padding: 20px; }
        .plus-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .plus-item { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; }
        .plus-icon-box { width: 50px; height: 50px; background: #fff; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; border: 1px solid #e5e5e5; }
        .plus-label { font-size: 11px; color: #888; }
        
        .chat-details-page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #f2f2f7; z-index: 200; transform: translateX(100%); transition: transform 0.3s; display: flex; flex-direction: column; }
        .chat-details-page.active { transform: translateX(0); }

        /* --- 202 æœ‹å‹åœˆæ ·å¼ --- */
        .moments-header { position: relative; height: 260px; margin-bottom: 40px; }
        .moments-cover { width: 100%; height: 100%; background-size: cover; background-position: center; cursor: pointer; background-color: #ccc; }
        .moments-user { position: absolute; bottom: -20px; right: 20px; display: flex; align-items: center; gap: 10px; }
        .moments-avatar { width: 70px; height: 70px; border-radius: 18px; border: 2px solid white; background-size: cover; background-position: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; }
        .moments-nick { color: white; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.5); font-size: 18px; cursor: pointer; margin-right: 10px; margin-bottom: 25px;}

        .moment-item { padding: 15px; border-bottom: 1px solid #f5f5f5; display: flex; gap: 10px; background: #fff; }
        .moment-avatar { width: 40px; height: 40px; border-radius: 8px; background-size: cover; background-position: center; flex-shrink: 0; background-color: #eee; }
        .moment-content { flex: 1; }
        .moment-name { color: #576b95; font-weight: 600; font-size: 15px; margin-bottom: 4px; }
        .moment-text { font-size: 15px; margin-bottom: 8px; line-height: 1.4; }
        .moment-img-placeholder { background-color: #f0f0f0; border-radius: 12px; /* ç»Ÿä¸€çš„æ–¹åœ†å½¢åœ†è§’ */ width: 200px; aspect-ratio: 1 / 1; /* å¼ºåˆ¶è®¾ä¸ºæ­£æ–¹å½¢ */ display: flex; align-items: center; justify-content: center;}
        .moment-meta { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #999; margin-top: 5px; }
        .moment-likes { background: #f7f7f7; padding: 5px 8px; border-radius: 4px; margin-top: 5px; font-size: 13px; color: #576b95; }

        /* --- "æˆ‘" çš„ç•Œé¢æ ·å¼ --- */
        .me-header { background: #fff; padding: 30px 20px; display: flex; align-items: center; gap: 15px; }
        .me-avatar { width: 64px; height: 64px; border-radius: 16px; background-size: cover; background-position: center; border: 1px solid #eee; cursor: pointer; overflow: hidden; display: flex; justify-content: center; align-items: center; font-size: 24px; color: #ccc;}
        .me-info input { border: none; font-size: 18px; font-weight: bold; width: 150px; background: transparent; }
        .me-info input:focus { border-bottom: 1px solid #ccc; outline: none; }
        .me-persona-box { margin-top: 5px; }
        .me-persona-input { font-size: 12px; color: #666; width: 100%; border: none; background: #f9f9f9; padding: 4px; border-radius: 4px; }

        .wallet-card { margin: 15px; background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); padding: 20px; border-radius: 16px; color: white; box-shadow: 0 4px 10px rgba(142, 197, 252, 0.4); }
        .wallet-label { font-size: 12px; opacity: 0.9; }
        .wallet-amount { font-size: 32px; font-weight: bold; margin-top: 5px; }

        .sticker-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 15px; background: #fff; }
        .sticker-item { aspect-ratio: 1/1; border-radius: 12px; border: 1px solid #eee; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; cursor: pointer; }
        .sticker-img { width: 100%; height: 100%; object-fit: cover; }
        .sticker-add { font-size: 24px; color: #ccc; }
        .sticker-del { position: absolute; top: 0; right: 0; background: rgba(0,0,0,0.5); color: white; font-size: 10px; padding: 2px 4px; border-bottom-left-radius: 6px; display: none; }
        .sticker-item:hover .sticker-del { display: block; }
        
        /* æ ·å¼è¡¥ä¸ */
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 4px; color: #333; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 8px 12px; border: 1px solid #dcdcdc; border-radius: 8px; font-size: 16px; }
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #e5e5e5; }
        .wallpaper-preview, .icon-style-preview { width: 60px; height: 60px; border-radius: 15px; cursor: pointer; border: 2px solid transparent; background-size: cover; background-position: center; display: flex; justify-content: center; align-items: center; color: #ccc; font-weight: bold; font-size: 20px; }
        .dashed-border { border: 2px dashed #ccc !important; border-radius: 10px; } 
        .save-btn {
            background-color: #e3f2ff;
            color: #4b5e7a;
            font-weight: bold;
            border-radius: 12px;
            padding: 8px 16px;
            margin-top: 8px;
            transition: transform 0.2s;
            width: 120px;
            border: none;
            box-shadow: none;
        }
        #save-icons-btn {
            background-color: #beddff;
        }
        .save-btn:active {
            transform: scale(0.95);
        }
        .couple-space-card { background-color: white; border-radius: 24px; padding: 16px; margin-bottom: 16px; box-shadow: 0 5px 15px rgba(255, 182, 193, 0.2); }
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }

        .msg-nudge {
            align-self: center;
            background: transparent;
            color: #888;
            font-size: 12px;
            margin: 8px 0;
            text-align: center;
            width: 100%;
        }

        .app-content, .page-content-520 {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }
        .app-content::-webkit-scrollbar, .page-content-520::-webkit-scrollbar {
            display: none; /* Chrome/Safari/Webkit */
        }

        @media (display-mode: standalone) {
            .mobile-container {
                width: 100%;
                height: 100%;
                border-radius: 0;
                border: none;
                box-shadow: none;
                transform: none;
            }
            .screen {
                padding-top: env(safe-area-inset-top);
                padding-left: max(20px, env(safe-area-inset-left));
                padding-right: max(20px, env(safe-area-inset-right));
                padding-bottom: max(20px, env(safe-area-inset-bottom));
            }
            .dynamic-island, .home-indicator {
                display: none !important;
            }
        }
    </style>
    <script src="database.js"></script>
</head>
<body>

    <div class="mobile-container">
        <div class="screen">
            <div class="dynamic-island"></div>
            <div class="content-wrapper" style="padding-top: 25%;">
                <div class="time-and-date"><div id="time" class="time"></div><div id="date" class="date"></div></div>
                <div class="home-content">
                    <div class="app-grid">
                        <!-- Icons will be rendered here by JavaScript -->
                    </div>
                    <div style="grid-column: span 2; text-align: center;">
                        <div id="tea-widget" class="love-widget" style="margin-top: 10px; position: relative; overflow: hidden; cursor: pointer; background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2);">
                            <div id="widget-bg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center;"></div>
                            <div style="position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 10px; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.15);">
                               <div class="flex flex-row items-center justify-center mb-2 gap-3">
                                   <img id="widget-avatar-me" src="" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; object-fit: cover; background-color: rgba(255,255,255,0.3);">
                                   <img id="widget-avatar-lover" src="" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; object-fit: cover; background-color: rgba(255,255,255,0.3);">
                               </div>
                               <div class="days-text">æ‹çˆ±ing</div>
                               <div id="love-days-text" class="days-count">...</div>
                            </div>
                        </div>
                        <span class="text-xs mt-1 text-center text-white" style="text-shadow: 0 1px 3px rgba(0,0,0,0.15);">Tea Widget</span>
                    </div>
                </div>
            </div>
            <div class="dock backdrop-blur">
                <!-- Dock icons will be rendered here by JavaScript -->
            </div>
        </div>
        
        <div id="chat-page" class="app-page"></div>
        <div id="world-book-page" class="app-page"></div>
        <div id="couple-space-page" class="app-page"></div>
        <div id="check-phone-page" class="app-page"></div>
        <div id="api-settings-page" class="app-page"></div>
        <div id="phone-page" class="app-page"></div>
        <div id="album-page" class="app-page"></div>
        <div id="settings-page" class="app-page"></div>
        <div id="ai-character-setup-page" class="app-page"></div>
        <div id="world-book-edit-page" class="app-page"></div>
        <div id="app-home-indicator" class="home-indicator" style="display: none;"></div>
    </div>

    <script>
        let tempIcons = {};

        function refreshAllUserAvatars() {
            const userAvatar = localStorage.getItem('user_avatar');
            if (!userAvatar) return;

            document.querySelectorAll('img[data-user-avatar="true"]').forEach(img => {
                img.src = userAvatar;
            });
             document.querySelectorAll('div[data-user-avatar="true"]').forEach(div => {
                div.innerHTML = `<img src="${userAvatar}" style="width:100%;height:100%;object-fit:cover;border-radius:inherit;">`;
            });
        }

        function renderHomeScreenIcons() {
            const apps = [
                { id: 'chat', name: '520', emoji: 'ğŸ’¬', container: '.app-grid' },
                { id: 'couple-space', name: 'å¿ƒè·³åŒé¢‘ä¸­', emoji: 'â¤ï¸', container: '.app-grid' },
                { id: 'world-book', name: 'ä¸–ç•Œä¹¦', emoji: 'ğŸ“–', container: '.app-grid' },
                { id: 'check-phone', name: 'æŸ¥æ‰‹æœº', emoji: 'ğŸ“±', container: '.app-grid' },
                { id: 'api-settings', name: 'API', emoji: 'âš™ï¸', container: '.dock' },
                { id: 'phone', name: 'é€šè¯', emoji: 'ğŸ“', container: '.dock' },
                { id: 'album', name: 'ç›¸å†Œ', emoji: 'ğŸ–¼ï¸', container: '.dock' },
                { id: 'settings', name: 'è®¾ç½®', emoji: 'ğŸ”§', container: '.dock' }
            ];

            apps.forEach(app => {
                const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><text x="50%" y="50%" dy=".1em" dominant-baseline="middle" text-anchor="middle" font-size="36">${app.emoji}</text></svg>`;
                try {
                    app.icon = `data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(svg)))}`;
                } catch (e) {
                    app.icon = `data:image/svg+xml;base64,${btoa(svg)}`; // Fallback for environments where unescape is deprecated
                }
            });

            document.querySelector('.app-grid').innerHTML = '';
            document.querySelectorAll('.dock .app-icon').forEach(icon => icon.remove());

            apps.forEach(app => {
                const container = document.querySelector(app.container);
                if (!container) return;

                const iconWrapper = document.createElement('div');
                iconWrapper.className = 'app-icon';
                iconWrapper.dataset.app = app.id;

                const iconImg = document.createElement('img');
                iconImg.className = 'app-icon-img';

                const savedIcon = localStorage.getItem(`icon_${app.id}`);
                iconImg.src = savedIcon || app.icon;

                if (savedIcon) {
                    iconImg.style.objectFit = 'cover';
                    iconImg.style.backgroundColor = 'transparent';
                    iconImg.style.backdropFilter = 'none';
                }

                const nameSpan = document.createElement('span');
                nameSpan.textContent = app.name;

                iconWrapper.appendChild(iconImg);
                iconWrapper.appendChild(nameSpan);
                container.appendChild(iconWrapper);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const timeEl = document.getElementById('time');
            const dateEl = document.getElementById('date');
            function updateTime() {
                const now = new Date();
                timeEl.textContent = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
                dateEl.textContent = now.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric', weekday: 'long' });
            }
            updateTime(); setInterval(updateTime, 1000);

            renderHomeScreenIcons();
            refreshAllUserAvatars();

            // --- æ¨¡æ¿å†…å®¹ ---
            const appContents = {
                chat: `
                    <div class="app-header-520">
                        <span class="close-btn-520 close-btn">ä¸»é¡µ</span>
                        <h2 class="title" id="chat-title">èŠå¤©</h2>
                        <span class="add-btn-520" id="add-contact-btn" style="display: none;">+</span>
                    </div>
                    <div class="app-content-520-wrapper">
                        <div id="page-200" class="page-content-520"></div>
                        <div id="page-201" class="page-content-520 active"></div>
                        <div id="page-202" class="page-content-520"></div>
                        <div id="page-me" class="page-content-520"></div>
                    </div>
                    <div class="bottom-nav-520">
                        <div class="nav-item-520" data-page="200"><span class="icon">ğŸ’¬</span><span>200</span></div>
                        <div class="nav-item-520 active" data-page="201"><span class="icon">ğŸ‘¥</span><span>201</span></div>
                        <div class="nav-item-520" data-page="202"><span class="icon">ğŸ½ï¸</span><span>202</span></div>
                        <div class="nav-item-520" data-page="me"><span class="icon">ğŸ°</span><span>æˆ‘</span></div>
                    </div>
                `,
                'couple-space': `
                    <div class="app-header"><span class="text-pink-500 cursor-pointer close-btn">ä¸»é¡µ</span><h2 class="font-bold">å¿ƒè·³åŒé¢‘ä¸­</h2><span class="w-10"></span></div>
                    <div class="app-content p-4 bg-pink-50/50 overflow-y-auto">
                        <div class="couple-space-card text-center"><p class="text-gray-500">æˆ‘ä»¬å·²ç»åœ¨ä¸€èµ·</p><p id="days-together" class="text-4xl font-bold text-pink-500 my-2">...</p><p class="text-gray-500">å¤©</p></div>
                        <div class="couple-space-card"><h3 class="font-bold mb-2">ğŸ’Œ å†™ç»™TAçš„æƒ…ä¹¦</h3><textarea id="love-letter-textarea" class="w-full h-24 p-2 border rounded-lg" placeholder="å†™ä¸‹ä½ çš„ç”œè¨€èœœè¯­..."></textarea><button id="save-love-letter" class="mt-2 w-full bg-pink-500 text-white py-2 rounded-lg">ä¿å­˜æƒ…ä¹¦</button></div>
                    </div>
                `,
                'world-book': `
                    <div class="app-header-520"><span class="close-btn-520 close-btn">ä¸»é¡µ</span><h2 class="title">ä¸–ç•Œä¹¦</h2><span class="add-btn-520" id="add-world-book-btn">+</span></div>
                    <div class="app-content p-0" id="world-book-list" style="background: #f7f7f7;"></div>
                `,
                'api-settings': `
                    <div class="app-header"><span class="text-black cursor-pointer close-btn">ä¸»é¡µ</span><h2 class="font-bold">API è®¾ç½®</h2><span class="w-10"></span></div>
                    <div class="app-content p-5">
                        <div class="form-group"><label>æ¨¡å‹å¹³å°</label><select id="api-platform" class="w-full p-2 border rounded-lg"><option value="openai">OpenAI</option><option value="gemini">Gemini</option><option value="MyAPI">MyAPI</option></select></div>
                        <div class="form-group"><label>API æ¥å£åœ°å€</label><input type="text" id="api-endpoint" placeholder="æ¥å£åœ°å€ (ä¾‹å¦‚ https://api.openai.com/v1)"></div>
                        <div class="form-group"><label>API å¯†é’¥</label><input type="password" id="api-key" placeholder="API Key"></div>
                        <div class="form-group">
                            <label>æ¨¡å‹</label>
                            <div class="flex gap-2">
                                <select id="api-model" class="w-full p-2 border rounded-lg bg-white hidden"></select>
                                <input type="text" id="api-model-custom" placeholder="è¾“å…¥æ¨¡å‹åç§°" class="w-full p-2 border rounded-lg bg-white">
                                <button id="fetch-models-btn" class="flex items-center justify-center w-10 h-10 flex-shrink-0 rounded-xl transition-all active:scale-95" style="background-color: #e0f2ff; border-radius: 12px;" title="è·å–æ¨¡å‹åˆ—è¡¨">ğŸ”„</button>
                            </div>
                        </div>
                        <button id="save-api-settings" class="mt-4 w-full text-white py-2 rounded-lg" style="background-color: #aed5ff;">ä¿å­˜è®¾ç½®</button>
                    </div>
                `,
                'settings': `
                    <div class="app-header"><span class="text-gray-600 cursor-pointer close-btn">ä¸»é¡µ</span><h2 class="font-bold">ç³»ç»Ÿè®¾ç½®</h2><span class="w-10"></span></div>
                    <div class="app-content p-5">
                        <div class="settings-item"><div><h3 class="font-bold">æ›´æ¢å£çº¸</h3><div class="wallpaper-options"><label for="wallpaper-upload" class="cursor-pointer border-2 border-dashed border-gray-300 rounded-lg w-16 h-20 flex items-center justify-center"><div id="wallpaper-preview-container" class="wallpaper-preview w-full h-full bg-cover bg-center rounded-lg">+</div></label><input type="file" id="wallpaper-upload" accept="image/*" class="hidden"></div><button id="save-wallpaper-btn" class="save-btn">ç¡®è®¤ä¿®æ”¹</button></div></div>
                        <div class="settings-item">
                            <div>
                                <h3 class="font-bold">æ›´æ¢åº”ç”¨å›¾æ ‡</h3>
                                <div class="grid grid-cols-4 gap-4 p-4" id="app-icon-list">
                                    <!-- Icons will be rendered here by initSettingsApp -->
                                </div>
                                <button id="save-icons-btn" class="save-btn">ç¡®è®¤ä¿®æ”¹</button>
                            </div>
                        </div>
                        <div class="settings-item">
                            <div>
                                <h3 class="font-bold">å°ç»„ä»¶é…ç½®</h3>
                                <div class="grid grid-cols-3 gap-4 p-4" id="widget-config-list">
                                    <!-- Widget config UI will be rendered here -->
                                </div>
                                <button id="save-widget-config-btn" class="save-btn">ç¡®è®¤ä¿®æ”¹</button>
                            </div>
                        </div>
                        <div class="settings-item"><button id="reset-settings-btn" class="w-full bg-red-500 text-white py-2 rounded-lg">é‡ç½®æ‰€æœ‰è®¾ç½®</button></div>
                    </div>
                `,
                'ai-character-setup': `
                    <div class="app-header"><span class="text-black cursor-pointer ml-3" id="back-to-contacts" style="font-size: 28px; width: 40px;">â€¹</span><h2 class="font-bold text-lg">è”ç³»äºº</h2><span class="w-12"></span></div>
                    <div class="app-content p-4 pb-24" style="background:#f2f2f7; overflow-y: auto;">
                        <input type="hidden" id="ai-contact-id">
                        <div class="bg-white rounded-xl p-4 mb-4 shadow-sm">
                            <h3 class="font-bold text-gray-800 mb-3 border-l-4 border-blue-500 pl-2">æ ¸å¿ƒ</h3>
                            <div class="flex items-start gap-4 mb-4"><label for="ai-avatar-upload" class="w-20 h-20 rounded-2xl bg-gray-100 flex items-center justify-center text-3xl cursor-pointer overflow-hidden border border-gray-200"><img id="ai-avatar-preview" src="" class="hidden w-full h-full object-cover"><span id="ai-avatar-emoji">ğŸ“·</span></label><input type="file" id="ai-avatar-upload" class="hidden" accept="image/*"><div class="flex-1 space-y-2"><div><label class="text-xs text-gray-500">å§“å</label><input type="text" id="ai-name" class="w-full border-b border-gray-200 py-1"></div><div><label class="text-xs text-gray-500">å¤‡æ³¨</label><input type="text" id="ai-notes" class="w-full border-b border-gray-200 py-1"></div></div></div>
                            <div><label class="text-xs text-gray-500">äººè®¾</label><textarea id="ai-persona" rows="3" class="w-full mt-1 p-2 bg-gray-50 rounded-lg text-sm border-none resize-none"></textarea></div>
                        </div>
                        <div class="bg-white rounded-xl p-4 mb-4 shadow-sm">
                            <h3 class="font-bold text-gray-800 mb-3 border-l-4 border-green-500 pl-2">è®°å¿†</h3>
                            <div class="mb-3"><label class="text-sm font-medium">è®°å¿†æ•°</label><input type="number" id="ai-context-limit" value="10" class="float-right w-16 text-center border rounded bg-gray-50"></div>
                            <div class="mb-3"><label class="text-sm font-medium block mb-1">ä¸–ç•Œä¹¦</label><select id="ai-world-book-select" class="w-full p-2 bg-gray-50 rounded border border-gray-200 text-sm"><option value="">(æ— )</option></select></div>
                            <div><label class="text-sm font-medium block mb-1">æ‰‹åŠ¨è®°å¿†</label><textarea id="ai-manual-memory" rows="2" class="w-full p-2 bg-gray-50 rounded-lg text-sm resize-none"></textarea></div>
                        </div>
                        <div class="bg-white rounded-xl p-4 mb-6 shadow-sm">
                            <h3 class="font-bold text-gray-800 mb-3 border-l-4 border-purple-500 pl-2">æ¨¡å¼</h3>
                            <div class="flex justify-between items-center mb-4"><span class="text-sm font-medium">çº¿ä¸‹æ¨¡å¼</span><div class="relative inline-block w-10 mr-2"><input type="checkbox" id="mode-offline" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/><label for="mode-offline" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label></div></div>
                            <div class="flex justify-between items-center"><span class="text-sm font-medium">å¿ƒå£°æ¨¡å¼</span><div class="relative inline-block w-10 mr-2"><input type="checkbox" id="mode-thoughts" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/><label for="mode-thoughts" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label></div></div>
                        </div>
                        <div class="space-y-3"><button id="ai-save-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl">ä¿å­˜</button><div class="flex gap-3"><button id="ai-chat-btn" class="flex-1 bg-white text-green-600 font-bold py-3 rounded-xl border hidden">èŠå¤©</button><button id="ai-delete-btn" class="flex-1 bg-white text-red-500 font-bold py-3 rounded-xl border hidden">åˆ é™¤</button></div></div>
                    </div>
                `
            };

            // --- åŠŸèƒ½æ¨¡å—é€»è¾‘ ---

            function setupChatApp(appPage) {
                appPage.classList.add('app-page-520');
                
                // åˆå§‹åŒ–æ•°æ®
                if(!localStorage.getItem('user_wallet')) localStorage.setItem('user_wallet', '0');
                if(!localStorage.getItem('user_stickers')) localStorage.setItem('user_stickers', '[]');
                if(!localStorage.getItem('moments_list')) localStorage.setItem('moments_list', '[]');
                if(!localStorage.getItem('moments_cover')) localStorage.setItem('moments_cover', 'https://images.unsplash.com/photo-1490750967868-58cb75069ed6?w=600'); 

                const navs = appPage.querySelectorAll('.nav-item-520');
                const pages = appPage.querySelectorAll('.page-content-520');
                const title = appPage.querySelector('#chat-title');
                const addBtn = appPage.querySelector('#add-contact-btn');
                
                const aiGenBtn = appPage.querySelector('#ai-gen-moment');
                if (aiGenBtn) {
                   aiGenBtn.onclick = async () => {
                        // 1. è·å–å½“å‰æ­£åœ¨èŠå¤©çš„è”ç³»äººæˆ–éšæœºé€‰ä¸€ä¸ªæœ‰â€œäººè®¾â€çš„è”ç³»äºº
                        const contacts = JSON.parse(localStorage.getItem('contacts') || '[]');
                        const targetAI = contacts.find(c => c.persona) || contacts[0];
        
                        if (!targetAI) return alert("è¯·å…ˆå»é€šè®¯å½•è®¾ç½®ä¸€ä¸ªæœ‰äººè®¾çš„AIè”ç³»äºº");

                        aiGenBtn.innerText = "â³"; // å˜æˆç­‰å¾…å›¾æ ‡

                        // 2. è°ƒç”¨ api_handler.js ä¸­çš„è¯·æ±‚æ–¹æ³• (å‡è®¾æ–¹æ³•åä¸º callAI)
                        // æ„é€  Prompt
                        const prompt = `ä½ æ˜¯${targetAI.name}ã€‚äººè®¾æ˜¯ï¼š${targetAI.persona}ã€‚
                        è¯·ä»¥ä½ çš„è¯­æ°”å†™ä¸€æ¡ç®€çŸ­çš„æœ‹å‹åœˆï¼Œå­—æ•°30å­—ä»¥å†…ã€‚åªéœ€è¾“å‡ºæ–‡å­—å†…å®¹ã€‚`;

                        try {
                        // è¿™é‡Œå‡è®¾ä½  api_handler.js æš´éœ²äº† handleChatRequest æˆ–ç±»ä¼¼å‡½æ•°
                        const response = await handleChatRequest([{ role: 'user', content: prompt }]);
                        const aiContent = response.choices[0].message.content;

                        // 3. å°†ç”Ÿæˆçš„å†…å®¹å­˜å…¥æœ‹å‹åœˆåˆ—è¡¨
                        const moments = JSON.parse(localStorage.getItem('moments_list') || '[]');
                        moments.unshift({
                        name: targetAI.name,
                        avatar: targetAI.avatar,
                        text: aiContent,
                        time: "åˆšåˆš",
                        likes: []
                    });
                    localStorage.setItem('moments_list', JSON.stringify(moments));
            
                    // 4. åˆ·æ–°æœ‹å‹åœˆé¡µé¢æ˜¾ç¤º
                    if(appPage.querySelector('#page-202').classList.contains('active')) {
                        renderMomentsList(appPage.querySelector('#page-202'));
                    }
                    alert("AI å·²æˆåŠŸå‘å¸ƒæœ‹å‹åœˆï¼");
                } catch (e) {
                    alert("ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ API é…ç½®");
                } finally {
                    aiGenBtn.innerText = "âœ¨";
                }
            };
        }
                // --- è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆæœ‹å‹åœˆå†…å®¹ ---
                const generateMoments = () => {
                    const contacts = DB.getContacts();
                    if (contacts.length === 0) return alert("é€šè®¯å½•é‡Œè¿˜æ²¡æœ‰äººå“¦ï¼Œå…ˆå»æ·»åŠ è”ç³»äººå§");
                    
                    const templates = [
                        { text: "ä»Šå¤©å¤©æ°”çœŸå¥½ï¼Œæƒ³å–å¥¶èŒ¶ ğŸ¥¤", imgDesc: "[å›¾ç‰‡: æ‰‹æŒå¥¶èŒ¶]" },
                        { text: "åœ¨è¿™ä¸ªåŸå¸‚çš„è§’è½ï¼Œå‘ç°ä¸€å®¶å®è—ä¹¦åº—ã€‚", imgDesc: "[å›¾ç‰‡: ä¹¦åº—ä¸€è§’]" },
                        { text: "åˆæ˜¯åŠªåŠ›å·¥ä½œçš„ä¸€å¤©ï¼ğŸ’ª", imgDesc: "" },
                        { text: "å¿ƒæƒ…æœ‰ç‚¹emo...", imgDesc: "[å›¾ç‰‡: é˜´å¤©çª—å¤–]" },
                        { text: "å“ˆå“ˆå“ˆç¬‘æ­»æˆ‘äº†", imgDesc: "[å›¾ç‰‡: æç¬‘è¡¨æƒ…]" }
                    ];

                    const newPosts = [];
                    // éšæœºé€‰å‡ ä¸ªè”ç³»äººå‘æœ‹å‹åœˆ
                    for(let i=0; i<3; i++) {
                        const contact = contacts[Math.floor(Math.random() * contacts.length)];
                        const tpl = templates[Math.floor(Math.random() * templates.length)];
                        const post = {
                            id: `moment_${Date.now()}_${i}`,
                            name: contact.notes || contact.name,
                            avatar: contact.avatar,
                            text: tpl.text,
                            imgDesc: tpl.imgDesc,
                            time: new Date().toISOString(),
                            likes: Math.random() > 0.5 ? ['AIåŠ©æ‰‹', 'è·¯äººç”²'] : [],
                            comments: []
                        };
                        newPosts.push(post);
                    }
                    
                    let current = JSON.parse(localStorage.getItem('moments_list') || '[]');
                    current = [...newPosts, ...current]; // æ–°çš„åœ¨å‰é¢
                    localStorage.setItem('moments_list', JSON.stringify(current));
                    go('202'); // åˆ·æ–°é¡µé¢
                };

                // --- èŠå¤©è¯¦æƒ…é¡µé€»è¾‘ (å«520è§¦å‘ & å¼•ç”¨) ---
                const formatTime = (date) => {
                    const now = new Date();
                    const isToday = date.toDateString() === now.toDateString();
                    const hours = date.getHours().toString().padStart(2, '0');
                    const mins = date.getMinutes().toString().padStart(2, '0');
                    if (isToday) {
                        return `${hours}:${mins}`;
                    }
                    // Check for yesterday
                    const yesterday = new Date(now);
                    yesterday.setDate(now.getDate() - 1);
                    if (date.toDateString() === yesterday.toDateString()) {
                        return `æ˜¨å¤© ${hours}:${mins}`;
                    }
                    return `${date.getMonth()+1}æœˆ${date.getDate()}æ—¥ ${hours}:${mins}`;
                };

                const openChat = (id) => {
                    const c = DB.getContact(id); if(!c) return;
                    let p = appPage.querySelector('#conversation-page');
                    if(!p) { 
                        p=document.createElement('div'); p.id='conversation-page'; p.className='chat-conversation-page'; 
                        p.style.cssText='position:absolute;top:0;left:0;width:100%;height:100%;background:#ededed;z-index:110;display:flex;flex-direction:column;'; 
                        appPage.appendChild(p); 
                    }
                    p.style.display = 'flex';
                    
                    p.innerHTML = `
                        <div class="app-header-520" style="background:#ededed;border:none;">
                            <span class="close-btn-520" id="chat-back" style="font-size:16px; cursor:pointer;">â€¹ è¿”å›</span>
                            <h2 class="title" style="transform: translateY(-3px);">${c.notes||c.name}</h2>
                            <span class="add-btn-520" id="chat-more" style="font-size:20px;">â€¢â€¢â€¢</span>
                        </div>
                        <div class="chat-messages" id="chat-box" style="${c.chatBackground?`background:url(${c.chatBackground}) center/cover no-repeat`:''}"></div>
                        <div class="chat-footer">
                            <div id="quote-preview" style="display:none; padding:8px; font-size:12px; color:#666; background:#f7f7f7; border-top:1px solid #ddd;">
                                å¼•ç”¨: <span id="quote-text-content"></span> <span id="quote-cancel" style="float:right;color:red;cursor:pointer;">Ã—</span>
                            </div>
                            <div class="chat-input-bar">
                                <div id="voice-sw-btn" class="chat-action-btn">
                                    <div class="wave-icon">
                                        <span></span>
                                        <span></span>
                                        <span></span>
                                    </div>
                                </div>
                                <input type="text" class="chat-input-field" id="chat-in">
                                <div class="chat-voice-btn" id="voice-btn" style="display:none;">æŒ‰ä½ è¯´è¯</div>
                                <div id="emoji-btn" class="chat-action-btn">â˜º</div>
                                <div id="plus-btn" class="chat-action-btn">+</div>
                                <div id="ai-btn" class="chat-action-btn">AI</div>
                            </div>
                            <div class="plus-panel" id="plus-p">
                                <div class="plus-grid">
                                    <div class="plus-item" id="p-trans"><div class="plus-icon-box" style="color:#fa9d3b;">ï¿¥</div><div class="plus-label">è½¬è´¦</div></div>
                                    <div class="plus-item" id="p-call"><div class="plus-icon-box" style="color:#07c160;">ğŸ“¹</div><div class="plus-label">é€šè¯</div></div>
                                    <div class="plus-item" id="p-pic"><div class="plus-icon-box" style="color:#10aeff;">ğŸ–¼ï¸</div><div class="plus-label">ç…§ç‰‡</div></div>
                                    <div class="plus-item" id="p-loc"><div class="plus-icon-box" style="color:#888;">ğŸ“</div><div class="plus-label">ä½ç½®</div></div>
                                    <div class="plus-item" id="p-cam"><div class="plus-icon-box" style="color:#000;">ğŸ“·</div><div class="plus-label">æ‹æ‘„</div></div>
                                </div>
                            </div>
                            <div class="plus-panel" id="emoji-p" style="height:0; overflow-y:auto;"></div>
                        </div>
                        <div class="chat-details-page" id="chat-sets"><div class="app-header-520"><span class="close-btn-520" id="set-back">â€¹</span><h2 class="title">è¯¦æƒ…</h2></div><div class="app-content p-4" id="sets-content"></div></div>
                    `;

                    const box=p.querySelector('#chat-box'), inp=p.querySelector('#chat-in'), plus=p.querySelector('#plus-p'), emojiP=p.querySelector('#emoji-p');
                    const quotePreview = p.querySelector('#quote-preview');
                    let currentQuote = null; 

                    const history = DB.getChatById(id) || [];
                    
                    const render = () => {
                        box.innerHTML = history.map((m, index) => {
                            if (m.type === 'nudge') return `<div class="msg-nudge">${m.text}</div>`;
                            if (m.type === 'timestamp') return `<div class="message-timestamp">${m.text}</div>`;
                            if(m.sender==='system') return `<div class="message-timestamp">${m.text}</div>`;
                            const me = m.sender==='me';
                            let quoteHtml = '';
                            if(m.quote) quoteHtml = `<span class="quote-content">${m.quote}</span>`;

                            let body = m.text;
                            if(m.type==='image') body=`<img src="${m.content}">`;
                            if(m.type==='sticker') body=`<img src="${m.content}" style="max-width:100px;">`;
                            if(m.type==='voice') {
                                body=`<div class="voice-body" style="display: flex; align-items: center; gap: 5px;">
                                        ${me?'':`<span style="color:red;font-size:8px;">â—</span>`} ${m.duration}"
                                      </div><div class="voice-text" style="display:none; margin-top: 5px; padding: 8px; background: rgba(0,0,0,0.05); border-radius: 8px; font-size: 14px;">${m.text}</div>`;
                            }
                            if(m.type==='transfer') body=`<div class="flex items-center gap-2"><div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">ï¿¥</div><div><div>ï¿¥${m.amount}</div><div class="text-xs opacity-70">${m.note}</div></div></div>`;
                            if(m.type==='location') body=`<div class="font-bold text-sm text-black">${m.content}</div><div class="text-xs text-gray-500">ä½ç½®</div><div class="w-full h-16 bg-gray-200 mt-1 flex items-center justify-center">ğŸ—ºï¸</div>`;

                            const userAvatar = localStorage.getItem('user_avatar');
                            const avatar = me ? `<div class="message-avatar" data-user-avatar="true">${userAvatar ? `<img src="${userAvatar}" style="width:100%;height:100%;object-fit:cover;border-radius:6px;">` : 'ğŸ‘¤'}</div>` : `<div class="message-avatar">${c.avatar}</div>`;
                            
                            return `
                                <div class="message-row ${me?'sent':'received'}" data-idx="${index}">
                                    ${avatar}
                                    <div class="message-bubble ${me?'sent':'received'} ${m.type||''} ${m.isQuoted?'quoting':''}" oncontextmenu="return false;">
                                        ${quoteHtml}
                                        ${body}
                                    </div>
                                </div>`;
                        }).join('');
                        box.scrollTop = box.scrollHeight;

                        // Add click listener for "pat-pat"
                        box.querySelectorAll('.message-row.received .message-avatar').forEach(avatarEl => {
                            avatarEl.onclick = () => {
                                if (avatarEl.disabled) return;
                                avatarEl.disabled = true;
                                setTimeout(() => { avatarEl.disabled = false; }, 1000);

                                const nudgeSuffix = c.nudge || "å¤´";
                                const nudgeText = `ä½ æ‹äº†æ‹ "${c.name}" çš„ ${nudgeSuffix}`;
                                send({
                                    id: `nudge_${Date.now()}`,
                                    sender: 'system',
                                    type: 'nudge',
                                    text: nudgeText,
                                    time: new Date()
                                });
                            };
                        });

                        let timer;
                        box.querySelectorAll('.message-bubble').forEach(el => {
                            const row = el.closest('.message-row');
                            const idx = row.dataset.idx;
                            const msg = history[idx];
                            const startPress = () => { timer = setTimeout(() => {
                                navigator.vibrate(50); 
                                currentQuote = msg.text || (msg.type === 'image' ? '[å›¾ç‰‡]' : '[æ¶ˆæ¯]');
                                quotePreview.style.display = 'block';
                                p.querySelector('#quote-text-content').textContent = currentQuote.substring(0, 15) + '...';
                                el.classList.add('quoting');
                            }, 500); };
                            const endPress = () => clearTimeout(timer);
                            el.addEventListener('mousedown', startPress);
                            el.addEventListener('touchstart', startPress);
                            el.addEventListener('mouseup', endPress);
                            el.addEventListener('touchend', endPress);
                            el.addEventListener('mouseleave', endPress);

                            if (msg.type === 'voice') {
                                el.onclick = () => {
                                    const voiceText = el.querySelector('.voice-text');
                                    if (voiceText) {
                                        voiceText.style.display = voiceText.style.display === 'none' ? 'block' : 'none';
                                    }
                                };
                            }
                        });
                    };
                    render();

                    const send = (msg) => { 
                        const lastMsg = history.length > 0 ? history[history.length - 1] : null;
                        if (lastMsg && msg.time && lastMsg.time) {
                            const timeDiff = new Date(msg.time) - new Date(lastMsg.time);
                            if (timeDiff > 300000) { // 5 minutes
                                const timeMsg = {
                                    id: `time_${Date.now()}`,
                                    sender: 'system',
                                    type: 'timestamp',
                                    text: formatTime(new Date(msg.time)),
                                    time: msg.time
                                };
                                DB.addMessage(id, timeMsg);
                                history.push(timeMsg);
                            }
                        }

                        if(currentQuote) {
                            msg.quote = currentQuote;
                            currentQuote = null;
                            quotePreview.style.display = 'none';
                        }
                        DB.addMessage(id, msg); 
                        history.push(msg); 
                        render(); 

                        if(msg.sender === 'me' && msg.type === 'text') {
                            const triggers = ['æ²¡é’±', 'ç©·', 'å‡ºé—¨ç©', 'ç©ºç©º', 'åƒåœŸ'];
                            if(triggers.some(t => msg.text.includes(t))) {
                                setTimeout(() => {
                                    const reply = {
                                        id: `r_${Date.now()}`, sender: 'ai', type: 'transfer', 
                                        amount: '520.00', note: 'æ‹¿å»èŠ±ï¼Œä¸å¤Ÿå†ç»™â¤ï¸', time: new Date()
                                    };
                                    DB.addMessage(id, reply);
                                    history.push(reply);
                                    render();
                                    let wallet = parseFloat(localStorage.getItem('user_wallet') || '0');
                                    wallet += 520;
                                    localStorage.setItem('user_wallet', wallet.toFixed(2));
                                }, 1500);
                            }
                        }
                    };

                    p.querySelector('#chat-back').onclick = () => {
                        p.style.display = 'none';
                        go('200');
                    };
                    p.querySelector('#quote-cancel').onclick=()=>{currentQuote=null; quotePreview.style.display='none'; render();}; 
                    
                    p.querySelector('#voice-sw-btn').onclick = () => {
                        const text = prompt("è¯·è¾“å…¥è¯­éŸ³å†…å®¹ï¼š");
                        if (text) {
                            const duration = Math.max(1, Math.ceil(text.length / 3));
                            send({
                                id: `m_${Date.now()}`,
                                sender: 'me',
                                type: 'voice',
                                text: text,
                                duration: duration,
                                time: new Date()
                            });
                        }
                    };
                    inp.onkeypress=(e)=>{if(e.key==='Enter'&&inp.value){send({id:`m_${Date.now()}`,sender:'me',type:'text',text:inp.value,time:new Date()});inp.value='';}};
                    
                    p.querySelector('#plus-btn').onclick=()=>{
                        plus.classList.toggle('open'); emojiP.classList.remove('open'); emojiP.style.height='0';
                        setTimeout(()=>box.scrollTop=box.scrollHeight,210);
                    };
                    
                    p.querySelector('#emoji-btn').onclick=()=>{
                        emojiP.classList.toggle('open'); plus.classList.remove('open');
                        if(emojiP.classList.contains('open')) {
                            emojiP.style.height = '180px';
                            const stickers = JSON.parse(localStorage.getItem('user_stickers')||'[]');
                            if(stickers.length === 0) {
                                emojiP.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">æš‚æ— è¡¨æƒ…ï¼Œå»â€œæˆ‘â€çš„ç•Œé¢æ·»åŠ </div>';
                            } else {
                                emojiP.innerHTML = `<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;padding:15px;">${stickers.map(s=>`<img src="${s.src}" style="width:100%;border-radius:8px;cursor:pointer;">`).join('')}</div>`;
                                emojiP.querySelectorAll('img').forEach(img => img.onclick = (e) => send({id:`m_${Date.now()}`,sender:'me',type:'sticker',content:e.target.src,time:new Date()}));
                            }
                        } else {
                            emojiP.style.height = '0';
                        }
                    };

                    p.querySelector('#p-trans').onclick=()=>{const a=prompt('é‡‘é¢');if(a) send({id:`m_${Date.now()}`,sender:'me',type:'transfer',amount:a,note:'è½¬è´¦',time:new Date()});};
                    p.querySelector('#p-pic').onclick=()=>{const d=prompt('å›¾ç‰‡æè¿°');if(d) send({id:`m_${Date.now()}`,sender:'me',type:'image',content:'https://images.unsplash.com/photo-1518020382113-a7e8fc38eac9?w=300',text:d,time:new Date()});};
                    
                    p.querySelector('#ai-btn').onclick = async () => {
                        const lastMsg = history[history.length - 1];
                        if (lastMsg) { 
                            const apiKey = localStorage.getItem('apiKey');
                            if (apiKey && typeof ApiHandler !== 'undefined') {
                                const btn = p.querySelector('#ai-btn');
                                const originalBtnText = btn.textContent;
                                btn.textContent = '...';
                                try {
                                    const pPlat = localStorage.getItem('apiPlatform') || 'openai';
                                    const ep = localStorage.getItem('apiEndpoint') || '';
                                    const m = localStorage.getItem('apiModel') || 'gpt-3.5-turbo';
                                    
                                    // 1. å‡†å¤‡äººè®¾ (System Prompt)
                                    const userNick = localStorage.getItem('user_nick') || 'ç©å®¶';
                                    let systemPrompt = `ä½ ç°åœ¨çš„èº«ä»½æ˜¯ï¼š${c.name}ã€‚\n`;
                                    if (c.notes) systemPrompt += `å¤‡æ³¨ï¼š${c.notes}ã€‚\n`;
                                    if (c.persona) systemPrompt += `ã€äººè®¾ã€‘ï¼š${c.persona}\n`;
                                    if (c.memory?.manual) systemPrompt += `ã€è®°å¿†ã€‘ï¼š${c.memory.manual}\n`;
                                    systemPrompt += `\nå¯¹è¯ç”¨æˆ·ï¼š${userNick}ã€‚\nè¯·ä¸¥æ ¼éµå®ˆäººè®¾ï¼Œå›å¤è‡ªç„¶ç®€çŸ­ã€‚`;

                                    // 2. æ ¼å¼åŒ–å‡½æ•°
                                    const getMsgText = (msg) => {
                                        if (msg.text) return msg.text;
                                        if (msg.type === 'image') return '[å›¾ç‰‡]';
                                        return '[æ¶ˆæ¯]';
                                    };

                                    let messages = [];

                                    // 3. æ ¸å¿ƒä¿®å¤ï¼šæ ¹æ®å¹³å°åŒºåˆ†æ ¼å¼
                                    if (pPlat === 'gemini') {
                                        // Gemini å¼ºåˆ¶è¦æ±‚ parts æ ¼å¼
                                        messages = history.slice(-15).map(msg => ({
                                            role: msg.sender === 'me' ? 'user' : 'model',
                                            parts: [{ text: getMsgText(msg) }]
                                        }));

                                        // äººè®¾æ³¨å…¥ï¼šæ‹¼æ¥åˆ°æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
                                        let lastUserIdx = -1;
                                        for (let i = messages.length - 1; i >= 0; i--) {
                                            if (messages[i].role === 'user') { lastUserIdx = i; break; }
                                        }
                                        if (lastUserIdx !== -1) {
                                            messages[lastUserIdx].parts[0].text = `ã€ç³»ç»ŸæŒ‡ä»¤ï¼š${systemPrompt}ã€‘\n\n${messages[lastUserIdx].parts[0].text}`;
                                        }
                                    } else {
                                        // OpenAI æ ‡å‡†æ ¼å¼
                                        messages = history.slice(-15).map(msg => ({
                                            role: msg.sender === 'me' ? 'user' : 'assistant',
                                            content: getMsgText(msg)
                                        }));
                                        messages.unshift({ role: 'system', content: systemPrompt });
                                    }

                                    // 4. å‘é€è¯·æ±‚
                                    const payload = ApiHandler.generateChatPayload(pPlat, ep, apiKey, m, messages);
                                    const res = await fetch(payload.url, payload.options);
                                    if (!res.ok) {
                                        const err = await res.json().catch(()=>({}));
                                        throw new Error(err.error?.message || `HTTP ${res.status}`);
                                    }
                                    
                                    const data = await res.json();
                                    const reply = ApiHandler.parseChatResponse(pPlat, data);
                                    if (reply) {
                                        send({ id: `r_${Date.now()}`, sender: 'ai', text: reply, time: new Date() });
                                    }
                                } catch (e) {
                                    alert('AI è¯·æ±‚å¤±è´¥: ' + e.message);
                                } finally {
                                    btn.textContent = originalBtnText;
                                }
                            }
                        }
                    };

                    const setsContent = p.querySelector('#sets-content');
                    p.querySelector('#chat-more').onclick=()=>{
                        p.querySelector('#chat-sets').classList.add('active');
                        setsContent.innerHTML = `
                            <div class="bg-white mt-2 rounded-lg overflow-hidden">
                                <div class="p-4 flex flex-col items-center border-bottom">
                                    <div class="w-16 h-16 rounded-lg bg-gray-200 mb-2 flex items-center justify-center text-3xl overflow-hidden">${c.avatar}</div>
                                    <div class="text-sm">${c.name}</div>
                                </div>
                            </div>
                            <div class="bg-white mt-4 rounded-lg overflow-hidden">
                                <div class="settings-item px-4" id="set-pat"><span>æ‹ä¸€æ‹</span><span class="text-gray-400">â€º</span></div>
                                <label for="bg-upload-input" class="settings-item px-4 cursor-pointer"><span>èŠå¤©èƒŒæ™¯</span><span class="text-gray-400">â€º</span></label>
                                <input type="file" id="bg-upload-input" class="hidden" accept="image/*">
                            </div>
                            <button id="set-clr" class="w-full mt-4 bg-white text-red-500 py-3 rounded-lg font-bold">æ¸…ç©ºèŠå¤©è®°å½•</button>
                        `;
                        setsContent.querySelector('#set-pat').onclick=()=>{const v=prompt('æ‹ä¸€æ‹å†…å®¹',c.nudge||'æ‹äº†æ‹æˆ‘');if(v){c.nudge=v;DB.saveContact(c);}};
                        
                        const bgUploadInput = setsContent.querySelector('#bg-upload-input');
                        bgUploadInput.onchange = (e) => {
                            const file = e.target.files[0];
                            if (file) {
                                const reader = new FileReader();
                                reader.onload = (evt) => {
                                    const newBg = evt.target.result;
                                    c.chatBackground = newBg;
                                    DB.saveContact(c);
                                    box.style.background = `url(${newBg}) center/cover no-repeat`;
                                    alert('èŠå¤©èƒŒæ™¯å·²æ›´æ–°');
                                };
                                reader.readAsDataURL(file);
                            }
                        };

                        setsContent.querySelector('#set-clr').onclick=()=>{if(confirm('æ¸…ç©º?')){DB.saveChats({...DB.getChats(),[id]:[]});history.length=0;render();p.querySelector('#chat-sets').classList.remove('active');}};
                    };
                    p.querySelector('#set-back').onclick=()=>{p.querySelector('#chat-sets').classList.remove('active');};
                };

                // --- é¡µé¢åˆ‡æ¢é€»è¾‘ ---
                const go = (pid) => {
                    navs.forEach(n => n.classList.toggle('active', n.dataset.page===pid));
                    pages.forEach(p => p.classList.toggle('active', p.id===`page-${pid}`));
                    
                    const el = document.getElementById(`page-${pid}`); 
                    el.innerHTML=''; // æ¸…ç©ºé‡ç»˜

                    if(pid==='200'){
                        title.textContent = 'èŠå¤©'; addBtn.style.display = 'none';
                        // æ¸…é™¤202é¡µé¢çš„æŒ‰é’®
                        const header = appPage.querySelector('.app-header-520');
                        header.querySelectorAll('.add-btn-520').forEach(e => {
                            if(e.id !== 'add-contact-btn') e.remove();
                        });
                        const chats = Object.keys(DB.getChats()).map(id=>{
                            const ms=DB.getChatById(id); if(!ms.length)return null;
                            return {c:DB.getContact(id), m:ms[ms.length-1], id};
                        }).filter(x=>x&&x.c).sort((a,b)=>new Date(b.m.time)-new Date(a.m.time));
                        if(chats.length===0) el.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-300">æš‚æ— èŠå¤©</div>`;
                        else {
                            el.innerHTML = chats.map(x=>`<div class="chat-list-item" data-id="${x.id}"><div class="chat-list-avatar">${x.c.avatar}</div><div class="chat-list-info"><div class="flex justify-between"><span class="font-medium">${x.c.notes||x.c.name}</span><span class="text-xs text-gray-400">${new Date(x.m.time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span></div><div class="text-gray-500 text-sm truncate">${x.m.type==='image'?'[å›¾ç‰‡]':(x.m.text||'[æ¶ˆæ¯]')}</div></div></div>`).join('');
                            el.querySelectorAll('.chat-list-item').forEach(i=>i.onclick=()=>openChat(i.dataset.id));
                        }
                    }

                    if(pid==='201'){
                        title.textContent = 'é€šè®¯å½•'; addBtn.style.display = 'block';
                        const header = appPage.querySelector('.app-header-520');
                        header.querySelectorAll('.add-btn-520').forEach(e => {
                            if(e.id !== 'add-contact-btn') e.remove();
                        });
                        const cs = DB.getContacts();
                        el.innerHTML = cs.map(c=>`<div class="chat-list-item contact-item" data-id="${c.id}"><div class="chat-list-avatar">${c.avatar}</div><div class="font-medium">${c.notes||c.name}</div></div>`).join('');
                        el.querySelectorAll('.contact-item').forEach(i=>i.onclick=()=>{
                            const setup=document.getElementById('ai-character-setup-page');
                            if(!setup.innerHTML) setup.innerHTML=appContents['ai-character-setup'];
                            setupAiCharacterPage(setup, i.dataset.id, ()=>go('201'));
                            setup.classList.add('active');
                        });
                    }

                    if(pid==='202'){
                        title.textContent = 'æœ‹å‹åœˆ';
                        addBtn.style.display = 'none';

                        // æ¸…é™¤æ‰€æœ‰æ—§æŒ‰é’®ï¼Œä½†ä¿ç•™ä¸»è¦çš„æ·»åŠ è”ç³»äººæŒ‰é’®
                        const header = appPage.querySelector('.app-header-520');
                        header.querySelectorAll('.add-btn-520').forEach(e => {
                            if (e.id !== 'add-contact-btn') e.remove();
                        });

                        const headerBtn = document.createElement('span');
                        headerBtn.className = 'add-btn-520';
                        headerBtn.innerHTML = 'âœ¨';
                        headerBtn.style.right = '45px';
                        headerBtn.onclick = generateMoments;
                        
                        const camBtn = document.createElement('span');
                        camBtn.className = 'add-btn-520';
                        camBtn.innerHTML = 'ğŸ“·'; 
                        camBtn.onclick = () => {
                            const txt = prompt('è¯´ç‚¹ä»€ä¹ˆ...');
                            if(txt) {
                                const myPost = {
                                    id: `my_moment_${Date.now()}`,
                                    name: localStorage.getItem('user_nick') || 'æˆ‘',
                                    avatar: localStorage.getItem('user_avatar') || '',
                                    text: txt,
                                    imgDesc: '[å›¾ç‰‡]',
                                    time: new Date().toISOString(),
                                    likes: [], comments: []
                                };
                                let list = JSON.parse(localStorage.getItem('moments_list')||'[]');
                                list.unshift(myPost);
                                localStorage.setItem('moments_list', JSON.stringify(list));
                                go('202');
                            }
                        };
                        
                        header.appendChild(headerBtn);
                        header.appendChild(camBtn);

                        const coverUrl = localStorage.getItem('moments_cover');
                        const userAvatar = localStorage.getItem('user_avatar');
                        const userNick = localStorage.getItem('user_nick') || 'ç‚¹å‡»ä¿®æ”¹æ˜µç§°';
                        const posts = JSON.parse(localStorage.getItem('moments_list') || '[]');

                        el.innerHTML = `
                            <div class="moments-header">
                                <div class="moments-cover" style="background-image:url(${coverUrl})"></div>
                                <div class="moments-user">
                                    <div class="moments-nick">${userNick}</div>
                                    <div class="moments-avatar" data-user-avatar="true">${userAvatar ? `<img src="${userAvatar}" style="width:100%;height:100%;object-fit:cover;border-radius:18px;">` : 'ğŸ‘¤'}</div>
                                </div>
                            </div>
                            <div class="moments-feed" style="padding-bottom:20px;">
                                ${posts.map(p => `
                                    <div class="moment-item" ${p.name === (localStorage.getItem('user_nick') || 'æˆ‘') ? 'data-author="me"' : ''}>
                                        <div class="moment-avatar" ${p.name === (localStorage.getItem('user_nick') || 'æˆ‘') ? 'data-user-avatar="true"' : ''}>${p.name === (localStorage.getItem('user_nick') || 'æˆ‘') && userAvatar ? `<img src="${userAvatar}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;">` : (p.avatar.includes('<')?p.avatar:`<img src="${p.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;">`)}</div>
                                        <div class="moment-content">
                                            <div class="moment-name">${p.name}</div>
                                            <div class="moment-text">${p.text}</div>
                                            ${p.imgDesc ? `<div class="moment-img-placeholder">${p.imgDesc}</div>` : ''}
                                            <div class="moment-meta">
                                                <span>${new Date(p.time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>
                                                <span style="font-size:16px;">ğŸ’¬</span>
                                            </div>
                                            ${p.likes.length ? `<div class="moment-likes">â¤ï¸ ${p.likes.join(', ')}</div>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <input type="file" id="cover-up" class="hidden" accept="image/*">
                        `;

                        el.querySelector('.moments-cover').onclick = () => el.querySelector('#cover-up').click();
                        el.querySelector('#cover-up').onchange = (e) => {
                            const f = e.target.files[0];
                            if(f) { const r=new FileReader(); r.onload=ev=>{localStorage.setItem('moments_cover', ev.target.result); go('202.js');}; r.readAsDataURL(f); }
                        };
                        el.querySelector('.moments-nick').onclick = () => {
                            const n = prompt('ä¿®æ”¹æ˜µç§°', userNick);
                            if(n) { localStorage.setItem('user_nick', n); go('202'); }
                        };
                    }

                    if(pid==='me'){
                        title.textContent = 'æˆ‘'; addBtn.style.display = 'none';
                        const header = appPage.querySelector('.app-header-520');
                        header.querySelectorAll('.add-btn-520').forEach(e => {
                            if(e.id !== 'add-contact-btn') e.remove();
                        });
                        const userAvatar = localStorage.getItem('user_avatar') || '';
                        const userNick = localStorage.getItem('user_nick') || 'æˆ‘çš„åå­—';
                        const userPersona = localStorage.getItem('user_persona') || '';
                        const wallet = localStorage.getItem('user_wallet') || '0.00';
                        const stickers = JSON.parse(localStorage.getItem('user_stickers') || '[]');

                        el.innerHTML = `
                            <div class="me-header">
                                <label for="me-avatar-upload" class="me-avatar" data-user-avatar="true">
                                    ${userAvatar ? `<img src="${userAvatar}" style="width:100%;height:100%;object-fit:cover;">` : 'ğŸ“·'}
                                </label>
                                <input type="file" id="me-avatar-upload" class="hidden" accept="image/*">
                                <div class="me-info">
                                    <input type="text" id="me-name-input" value="${userNick}" placeholder="åå­—">
                                    <div class="me-persona-box">
                                        <input type="text" id="me-persona-input" class="me-persona-input" value="${userPersona}" placeholder="æˆ‘çš„äººè®¾...">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="wallet-card">
                                <div class="wallet-label">é›¶é’±ä½™é¢ (520ä¸“å±)</div>
                                <div class="wallet-amount">ï¿¥${wallet}</div>
                                <div style="font-size:10px; margin-top:5px; opacity:0.8;">æç¤ºï¼šåœ¨èŠå¤©ä¸­å“­ç©·è¯•è¯•ï¼Ÿ</div>
                            </div>

                            <div style="background:white; margin-top:10px;">
                                <div style="padding:15px; font-weight:bold; border-bottom:1px solid #f0f0f0;">è¡¨æƒ…åŒ…åº“</div>
                                <div class="sticker-grid">
                                    <label class="sticker-item sticker-add">
                                        + <input type="file" id="sticker-upload" class="hidden" accept="image/*">
                                    </label>
                                    ${stickers.map((s, idx) => `
                                        <div class="sticker-item">
                                            <img src="${s.src}" class="sticker-img">
                                            <div class="sticker-del" data-idx="${idx}">åˆ </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;

                        el.querySelector('#me-avatar-upload').onchange = (e) => {
                            const file = e.target.files[0];
                            if (!file) return;

                            const reader = new FileReader();
                            reader.onload = (event) => {
                                const img = new Image();
                                img.onload = () => {
                                    const canvas = document.createElement('canvas');
                                    const ctx = canvas.getContext('2d');
                                    canvas.width = 200;
                                    canvas.height = 200;
                                    ctx.drawImage(img, 0, 0, 200, 200);
                                    const compressedBase64 = canvas.toDataURL('image/jpeg', 0.8);
                                    
                                    localStorage.setItem('user_avatar', compressedBase64);
                                    go('me');
                                    refreshAllUserAvatars();
                                };
                                img.src = event.target.result;
                            };
                            reader.readAsDataURL(file);
                        };
                        el.querySelector('#me-name-input').onchange = (e) => localStorage.setItem('user_nick', e.target.value);
                        el.querySelector('#me-persona-input').onchange = (e) => localStorage.setItem('user_persona', e.target.value);
                        
                        el.querySelector('#sticker-upload').onchange = (e) => {
                            const f = e.target.files[0];
                            if(f){ 
                                const r = new FileReader(); 
                                r.onload = ev => {
                                    const memo = prompt("è¯·è¾“å…¥æ­¤è¡¨æƒ…çš„å¤‡æ³¨/æ–‡å­—ï¼ˆå°†æ˜¾ç¤ºåœ¨è¡¨æƒ…ä¸‹æ–¹ï¼‰", "è¡¨æƒ…");
                                    const newSticker = { src: ev.target.result, memo: memo || "" };
                                    const list = JSON.parse(localStorage.getItem('user_stickers') || '[]');
                                    list.push(newSticker);
                                    localStorage.setItem('user_stickers', JSON.stringify(list));
                                    go('me');
                                }; 
                                r.readAsDataURL(f); 
                            }
                        };
                        
                        el.querySelectorAll('.sticker-del').forEach(btn => {
                            btn.onclick = (e) => {
                                e.stopPropagation(); 
                                const idx = parseInt(e.target.dataset.idx);
                                const list = JSON.parse(localStorage.getItem('user_stickers')||'[]');
                                list.splice(idx, 1);
                                localStorage.setItem('user_stickers', JSON.stringify(list));
                                go('me');
                            };
                        });
                    }
                };

                navs.forEach(n => n.onclick=()=>go(n.dataset.page));
                addBtn.onclick=()=>{
                    const setup=document.getElementById('ai-character-setup-page');
                    if(!setup.innerHTML) setup.innerHTML=appContents['ai-character-setup'];
                    setupAiCharacterPage(setup, null, ()=>go('201'));
                    setup.classList.add('active');
                };
                
                go('200');
            }


            function setupApiSettingsApp(appPage) {
                const platform = appPage.querySelector('#api-platform');
                const endpoint = appPage.querySelector('#api-endpoint');
                const key = appPage.querySelector('#api-key');
                const modelSelect = appPage.querySelector('#api-model');
                const modelCustom = appPage.querySelector('#api-model-custom');
                const fetchBtn = appPage.querySelector('#fetch-models-btn');
                
                platform.value = localStorage.getItem('apiPlatform') || 'openai';
                endpoint.value = localStorage.getItem('apiEndpoint') || '';
                key.value = localStorage.getItem('apiKey') || '';
                modelCustom.value = localStorage.getItem('apiModel') || '';

                fetchBtn.onclick = async () => {
                    if (typeof ApiHandler === 'undefined') return alert('è¯·ç¡®ä¿ api_handler.js å·²æ­£ç¡®åŠ è½½');
                    const p = platform.value;
                    const ep = endpoint.value;
                    const k = key.value;
                    if(!k) return alert('è¯·è¾“å…¥API Key');

                    fetchBtn.textContent = '...';
                    try {
                        const models = await ApiHandler.fetchModels(p, ep, k);
                        if(models.length) {
                            modelSelect.innerHTML = models.map(m => `<option value="${m}">${m}</option>`).join('');
                            modelSelect.classList.remove('hidden');
                            modelCustom.classList.add('hidden');
                            modelSelect.onchange = () => modelCustom.value = modelSelect.value;
                            if(!modelCustom.value) modelCustom.value = models[0];
                            alert(`æˆåŠŸè·å– ${models.length} ä¸ªæ¨¡å‹`);
                        } else {
                            throw new Error('æœªæ‰¾åˆ°æ¨¡å‹æ•°æ®');
                        }
                    } catch (e) {
                        console.error(e);
                        alert('è·å–å¤±è´¥: ' + e.message);
                    }
                    fetchBtn.textContent = 'ğŸ”„';
                };

                appPage.querySelector('#save-api-settings').onclick = () => {
                    localStorage.setItem('apiPlatform', platform.value);
                    localStorage.setItem('apiEndpoint', endpoint.value);
                    localStorage.setItem('apiKey', key.value);
                    localStorage.setItem('apiModel', modelCustom.value);
                    alert('APIé…ç½®å·²ä¿å­˜');
                };
            }

            function setupCoupleSpaceApp(appPage) {
                const dayEl = appPage.querySelector('#days-together');
                const start = new Date('2023-01-01');
                dayEl.textContent = Math.ceil(Math.abs(new Date() - start) / (1000 * 60 * 60 * 24));
                
                const letter = appPage.querySelector('#love-letter-textarea');
                letter.value = localStorage.getItem('loveLetter') || '';
                appPage.querySelector('#save-love-letter').onclick = () => { localStorage.setItem('loveLetter', letter.value); alert('æƒ…ä¹¦å·²ä¿å­˜'); };
            }

            function setupWorldBookApp(appPage) {
                const addBtn = appPage.querySelector('#add-world-book-btn');
                const listEl = appPage.querySelector('#world-book-list');
                const render = () => {
                    const books = JSON.parse(localStorage.getItem('m-tea-world-books-list') || '[]');
                    if(books.length===0) listEl.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-400 mt-20"><span style="font-size:40px;">ğŸ“–</span><p>æš‚æ— ä¸–ç•Œä¹¦</p></div>`;
                    else listEl.innerHTML = `<div class="divide-y divide-gray-200 bg-white mt-4 border-t border-b">${books.map(b => `<div class="p-4 flex justify-between items-center cursor-pointer hover:bg-gray-50 wb-item" data-id="${b.id}"><div class="font-medium text-lg">${b.name}</div><div class="text-gray-400">â€º</div></div>`).join('')}</div>`;
                    appPage.querySelectorAll('.wb-item').forEach(i => i.onclick = () => edit(i.dataset.id));
                };
                const edit = (id) => {
                    let p = document.getElementById('world-book-edit-page');
                    if(!p.innerHTML) p.innerHTML = `<div class="app-header-520"><span class="close-btn-520" id="wb-no">å–æ¶ˆ</span><h2 class="title">ç¼–è¾‘</h2><span class="add-btn-520" id="wb-yes" style="font-size:16px;color:#07c160;font-weight:bold;">å®Œæˆ</span></div><div class="app-content p-4" style="background:#f2f2f7;"><input type="hidden" id="wb-id"><div class="bg-white rounded-lg p-2 mb-4"><input id="wb-name" class="w-full text-lg font-bold p-2 focus:outline-none" placeholder="ä¹¦å"></div><div class="bg-white rounded-lg p-2 flex-grow h-64"><textarea id="wb-c" class="w-full h-full p-2 resize-none focus:outline-none" placeholder="è®¾å®š..."></textarea></div><button id="wb-del" class="w-full mt-4 bg-white text-red-500 py-3 rounded-lg font-bold">åˆ é™¤</button></div>`;
                    const iId=p.querySelector('#wb-id'), iN=p.querySelector('#wb-name'), iC=p.querySelector('#wb-c'), del=p.querySelector('#wb-del');
                    iId.value=id||''; iN.value=''; iC.value=''; del.style.display=id?'block':'none';
                    if(id){ const b=JSON.parse(localStorage.getItem('m-tea-world-books-list')||'[]').find(x=>x.id===id); if(b){iN.value=b.name;iC.value=b.content;} }
                    p.querySelector('#wb-no').onclick=()=>{p.classList.remove('active');p.style.zIndex='200';};
                    p.querySelector('#wb-yes').onclick=()=>{
                        if(!iN.value)return; let bs=JSON.parse(localStorage.getItem('m-tea-world-books-list')||'[]');
                        const nb={id:iId.value||`wb_${Date.now()}`,name:iN.value,content:iC.value};
                        if(iId.value){const idx=bs.findIndex(x=>x.id===iId.value);if(idx>-1)bs[idx]=nb;}else bs.push(nb);
                        localStorage.setItem('m-tea-world-books-list',JSON.stringify(bs)); render(); p.classList.remove('active');
                    };
                    p.querySelector('#wb-del').onclick=()=>{if(confirm('åˆ é™¤?')){let bs=JSON.parse(localStorage.getItem('m-tea-world-books-list')||'[]');bs=bs.filter(x=>x.id!==iId.value);localStorage.setItem('m-tea-world-books-list',JSON.stringify(bs));render();p.classList.remove('active');}};
                    p.style.zIndex='350'; p.classList.add('active');
                };
                addBtn.onclick = () => edit(null);
                render();
            }

            function setupAiCharacterPage(appPage, contactId, onSaveCallback) {
                const backBtn = appPage.querySelector('#back-to-contacts');
                const saveBtn = appPage.querySelector('#ai-save-btn');
                const chatBtn = appPage.querySelector('#ai-chat-btn');
                const deleteBtn = appPage.querySelector('#ai-delete-btn');
                const idInput = appPage.querySelector('#ai-contact-id');
                const nameInput = appPage.querySelector('#ai-name');
                const notesInput = appPage.querySelector('#ai-notes');
                const personaInput = appPage.querySelector('#ai-persona');
                const contextLimitInput = appPage.querySelector('#ai-context-limit');
                const worldBookSelect = appPage.querySelector('#ai-world-book-select');
                const manualMemoryInput = appPage.querySelector('#ai-manual-memory');
                const offlineToggle = appPage.querySelector('#mode-offline');
                const thoughtsToggle = appPage.querySelector('#mode-thoughts');
                const avatarPreview = appPage.querySelector('#ai-avatar-preview');
                const avatarEmoji = appPage.querySelector('#ai-avatar-emoji');
                const avatarUpload = appPage.querySelector('#ai-avatar-upload');

                const worldBooks = JSON.parse(localStorage.getItem('m-tea-world-books-list') || '[]');
                worldBookSelect.innerHTML = '<option value="">(æ— )</option>' + worldBooks.map(wb => `<option value="${wb.id}">${wb.name}</option>`).join('');

                let currentAvatar = 'ğŸ¤–';
                avatarUpload.onchange = (e) => {
                    const file = e.target.files[0];
                    if(file){
                        const reader = new FileReader();
                        reader.onload = (evt) => {
                            currentAvatar = `<img src="${evt.target.result}" style="width:100%;height:100%;object-fit:cover;">`;
                            avatarPreview.src = evt.target.result;
                            avatarPreview.classList.remove('hidden');
                            avatarEmoji.classList.add('hidden');
                        };
                        reader.readAsDataURL(file);
                    }
                };

                idInput.value = contactId || '';
                nameInput.value = ''; notesInput.value = ''; personaInput.value = '';
                contextLimitInput.value = 10; worldBookSelect.value = ''; manualMemoryInput.value = '';
                offlineToggle.checked = false; thoughtsToggle.checked = false;
                avatarPreview.classList.add('hidden'); avatarEmoji.classList.remove('hidden');

                if (!contactId) {
                    chatBtn.style.display = 'none';
                    deleteBtn.style.display = 'none';
                } else {
                    chatBtn.style.display = 'block';
                    deleteBtn.style.display = 'block';
                    const contact = DB.getContact(contactId);
                    if (contact) {
                        nameInput.value = contact.name;
                        notesInput.value = contact.notes || '';
                        personaInput.value = contact.persona || '';
                        if(contact.memory) {
                            contextLimitInput.value = contact.memory.contextLimit || 10;
                            worldBookSelect.value = contact.memory.worldBookId || '';
                            manualMemoryInput.value = contact.memory.manual || '';
                        }
                        if(contact.mode) {
                            offlineToggle.checked = contact.mode.offline || false;
                            thoughtsToggle.checked = contact.mode.innerThoughts || false;
                        }
                        if(contact.avatar && contact.avatar.includes('img')) {
                             const src = contact.avatar.match(/src="([^"]*)"/)[1];
                             avatarPreview.src = src;
                             avatarPreview.classList.remove('hidden');
                             avatarEmoji.classList.add('hidden');
                             currentAvatar = contact.avatar;
                        }
                    }
                }

                saveBtn.onclick = () => {
                    if (!nameInput.value.trim()) return alert('è¯·è¾“å…¥å§“å');
                    const contactData = {
                        id: idInput.value || `contact_${Date.now()}`,
                        name: nameInput.value,
                        notes: notesInput.value,
                        avatar: currentAvatar,
                        persona: personaInput.value,
                        memory: {
                            contextLimit: contextLimitInput.value,
                            worldBookId: worldBookSelect.value,
                            manual: manualMemoryInput.value
                        },
                        mode: {
                            offline: offlineToggle.checked,
                            innerThoughts: thoughtsToggle.checked
                        }
                    };
                    DB.saveContact(contactData);
                    alert('ä¿å­˜æˆåŠŸ');
                    if(onSaveCallback) onSaveCallback();
                };
                
                chatBtn.onclick = () => {
                    const currentId = idInput.value;
                    const chats = DB.getChats();
                    if (!chats[currentId]) {
                        DB.addMessage(currentId, {
                            id: `msg_init_${Date.now()}`, sender: 'system', text: 'ä½ ä»¬å·²æˆä¸ºå¥½å‹ï¼Œå¼€å§‹èŠå¤©å§', time: new Date().toISOString()
                        });
                    }
                    appPage.classList.remove('active');
                    const chatApp = document.getElementById('chat-page');
                    const nav200 = chatApp.querySelector('.nav-item-520[data-page="200"]');
                    if(nav200) nav200.click();
                };

                deleteBtn.onclick = () => {
                    if (confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) {
                        DB.deleteContact(idInput.value);
                        if(onSaveCallback) onSaveCallback();
                        appPage.classList.remove('active');
                    }
                }
                
                backBtn.onclick = () => appPage.classList.remove('active');
            }

            function setupTeaWidget() {
                const widget = document.getElementById('tea-widget');
                if (!widget) return;

                const daysText = document.getElementById('love-days-text');
                const widgetBg = document.getElementById('widget-bg');
                const avatarMe = document.getElementById('widget-avatar-me');
                const avatarLover = document.getElementById('widget-avatar-lover');

                function updateLoveDays() {
                    const startDate = localStorage.getItem('loveStartDate');
                    if (!startDate) {
                        daysText.innerText = '...';
                        return;
                    }
                    const start = new Date(startDate);
                    const now = new Date();
                    const diffTime = Math.abs(now - start);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    daysText.innerText = `${diffDays}å¤©`;
                }

                function updateWidgetDisplay() {
                    const bg = localStorage.getItem('widget_bg');
                    const widgetContainer = document.getElementById('tea-widget');
                    if (bg) {
                        widgetBg.style.backgroundImage = `url(${bg})`;
                        widgetContainer.style.background = 'transparent';
                        widgetContainer.style.backdropFilter = 'none';
                    } else {
                        widgetBg.style.backgroundImage = '';
                        widgetContainer.style.background = 'rgba(255, 255, 255, 0.3)';
                        widgetContainer.style.backdropFilter = 'blur(10px)';
                    }

                    avatarMe.src = localStorage.getItem('widget_avatar_me') || '';
                    avatarLover.src = localStorage.getItem('widget_avatar_lover') || '';
                }

                widget.addEventListener('click', () => {
                    const date = prompt('è¯·è¾“å…¥ä½ ä»¬åœ¨ä¸€èµ·çš„æ—¥æœŸ (æ ¼å¼: YYYY-MM-DD)', localStorage.getItem('loveStartDate') || '');
                    if (date && !isNaN(new Date(date))) {
                        localStorage.setItem('loveStartDate', date);
                        updateLoveDays();
                    } else if (date !== null && date !== '') {
                        alert('æ—¥æœŸæ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·è¾“å…¥ YYYY-MM-DD æ ¼å¼');
                    }
                });

                updateWidgetDisplay();
                updateLoveDays();
                
                window.addEventListener('storage', (e) => {
                    if (e.key === 'widget_bg' || e.key === 'widget_avatar_me' || e.key === 'widget_avatar_lover' || e.key === 'loveStartDate') {
                        updateWidgetDisplay();
                        updateLoveDays();
                    }
                });
                window.updateWidgetDisplay = updateWidgetDisplay;
            }

            setupTeaWidget();
            
            function renderSettingsIconsList() {
                const appIconList = document.querySelector('#app-icon-list');
                if (!appIconList) return;

                const appNameMap = {
                    'chat': '520', 'couple-space': 'å¿ƒè·³åŒé¢‘ä¸­', 'world-book': 'ä¸–ç•Œä¹¦', 'check-phone': 'æŸ¥æ‰‹æœº',
                    'api-settings': 'API', 'phone': 'é€šè¯', 'album': 'ç›¸å†Œ', 'settings': 'è®¾ç½®'
                };
                const appsToChange = Object.keys(appNameMap).map(id => ({ id, name: appNameMap[id] }));

                appIconList.innerHTML = appsToChange.map(app => {
                    // ä¼˜å…ˆä½¿ç”¨ tempIcons,å…¶æ¬¡ä½¿ç”¨ localStorage
                    const savedIcon = tempIcons[app.id] || localStorage.getItem(`icon_${app.id}`);
                    return `
                    <div class="flex flex-col items-center gap-1">
                        <label class="relative w-12 h-12 aspect-square flex items-center justify-center border-2 border-dashed border-gray-300 rounded-xl cursor-pointer overflow-hidden bg-gray-50 hover:bg-gray-100"
                               style="${savedIcon ? `background-image: url(${savedIcon}); background-size: cover; background-position: center; border-style: solid;` : ''}">
                            <input type="file" class="hidden icon-input" data-app="${app.id}" accept="image/*">
                            <span class="text-gray-400 text-xl ${savedIcon ? 'hidden' : ''}">+</span>
                        </label>
                        <span class="text-[10px] text-gray-500">${app.name}</span>
                    </div>
                `}).join('');

                appIconList.querySelectorAll('.icon-input').forEach(input => {
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const base64 = event.target.result;
                            const appId = input.dataset.app;
                            tempIcons[appId] = base64;

                            const label = input.parentElement;
                            label.style.backgroundImage = `url(${base64})`;
                            label.style.backgroundSize = 'cover';
                            label.style.backgroundPosition = 'center';
                            label.style.borderStyle = 'solid';
                            label.querySelector('span').classList.add('hidden');
                        };
                        reader.readAsDataURL(file);
                    };
                });
            }

            document.querySelector('.screen').addEventListener('click', (e) => {
                const icon = e.target.closest('.app-icon');
                if (!icon || !icon.dataset.app) return;

                const appId = icon.dataset.app;
                const appPage = document.getElementById(`${appId}-page`);
                const screen = document.querySelector('.screen');

                if (appPage) {
                    if (!appPage.innerHTML) {
                        let content = appContents[appId] || `<div class="app-header"><span class="close-btn">ä¸»é¡µ</span><h2 class="font-bold">${icon.querySelector('span').textContent}</h2><span></span></div><div class="app-content p-5"><p>å¼€å‘ä¸­...</p></div>`;
                        appPage.innerHTML = content;
                        
                        if (appId === 'chat') setupChatApp(appPage);
                        else if (appId === 'world-book') setupWorldBookApp(appPage);
                        else if (appId === 'couple-space') setupCoupleSpaceApp(appPage);
                        else if (appId === 'api-settings') setupApiSettingsApp(appPage);
                    }

                    if (appId === 'settings') {
                        // This block is now self-contained and re-initializes everything on open.
                        appPage.innerHTML = appContents['settings'];

                        function initSettingsContent() {
                            // This is the main initialization function for the settings page.
                            // It's called every time the settings app is opened to ensure all event listeners are correctly bound.

                            // --- Helper for uploads ---
                            function handleImageUpload(file, key, tempStore, labelElement) {
                                if (!file) return;
                                const reader = new FileReader();
                                reader.onload = (event) => {
                                    const base64 = event.target.result;
                                    tempStore[key] = base64;
                                    labelElement.style.backgroundImage = `url(${base64})`;
                                    labelElement.style.backgroundSize = 'cover';
                                    labelElement.style.backgroundPosition = 'center';
                                    labelElement.style.borderStyle = 'solid';
                                    labelElement.querySelector('span')?.classList.add('hidden');
                                };
                                reader.readAsDataURL(file);
                            }

                            // --- App Icon Logic ---
                            function initAppIconLogic() {
                                const appIconList = appPage.querySelector('#app-icon-list');
                                const saveIconsBtn = appPage.querySelector('#save-icons-btn');
                                const appNameMap = {
                                    'chat': '520', 'couple-space': 'å¿ƒè·³åŒé¢‘ä¸­', 'world-book': 'ä¸–ç•Œä¹¦', 'check-phone': 'æŸ¥æ‰‹æœº',
                                    'api-settings': 'API', 'phone': 'é€šè¯', 'album': 'ç›¸å†Œ', 'settings': 'è®¾ç½®'
                                };
                                const appsToChange = Object.keys(appNameMap).map(id => ({ id, name: appNameMap[id] }));
                                
                                appIconList.innerHTML = appsToChange.map(app => {
                                    const currentIcon = tempIcons[app.id] || localStorage.getItem(`icon_${app.id}`);
                                    return `<div class="flex flex-col items-center gap-1"><label class="relative w-12 h-12 aspect-square flex items-center justify-center border-2 border-dashed border-gray-300 rounded-xl cursor-pointer overflow-hidden bg-gray-50 hover:bg-gray-100" style="${currentIcon ? `background-image: url(${currentIcon}); background-size: cover; background-position: center; border-style: solid;` : ''}"><input type="file" class="hidden icon-input" data-app="${app.id}" accept="image/*"><span class="text-gray-400 text-xl ${currentIcon ? 'hidden' : ''}">+</span></label><span class="text-[10px] text-gray-500">${app.name}</span></div>`;
                                }).join('');

                                appIconList.querySelectorAll('.icon-input').forEach(input => {
                                    input.onchange = (e) => handleImageUpload(e.target.files[0], input.dataset.app, tempIcons, input.parentElement);
                                });

                                saveIconsBtn.onclick = () => {
                                    for (let id in tempIcons) { localStorage.setItem(`icon_${id}`, tempIcons[id]); }
                                    alert('å›¾æ ‡ä¿®æ”¹æˆåŠŸï¼');
                                    renderHomeScreenIcons();
                                    tempIcons = {};
                                    initSettingsContent(); // Re-init all settings
                                };
                            }

                            // --- Widget Config Logic ---
                            function initSettingsWidgetLogic() {
                                const widgetConfigList = appPage.querySelector('#widget-config-list');
                                const saveWidgetConfigBtn = appPage.querySelector('#save-widget-config-btn');
                                let tempWidgetData = {};

                                saveWidgetConfigBtn.style.backgroundColor = '#b8d8e8';
                                
                                // Render UI
                                widgetConfigList.innerHTML = `
                                    <div class="col-span-3 flex flex-col items-center gap-1">
                                        <label class="relative w-full h-20 aspect-video flex items-center justify-center border-2 border-dashed border-gray-300 rounded-xl cursor-pointer overflow-hidden bg-gray-50 hover:bg-gray-100" style="${(localStorage.getItem('widget_bg')) ? `background-image: url(${localStorage.getItem('widget_bg')}); background-size: cover; background-position: center; border-style: solid;` : ''}">
                                            <input type="file" class="hidden widget-input" data-key="widget_bg" accept="image/*">
                                            <span class="text-gray-400 text-xl ${localStorage.getItem('widget_bg') ? 'hidden' : ''}">+</span>
                                        </label>
                                        <span class="text-[10px] text-gray-500">å°ç»„ä»¶èƒŒæ™¯</span>
                                    </div>
                                    <div class="col-span-3 grid grid-cols-2 gap-4">
                                        <div class="flex flex-col items-center gap-1">
                                            <label class="relative w-16 h-16 aspect-square flex items-center justify-center border-2 border-dashed border-gray-300 rounded-full cursor-pointer overflow-hidden bg-gray-50 hover:bg-gray-100" style="${(localStorage.getItem('widget_avatar_me')) ? `background-image: url(${localStorage.getItem('widget_avatar_me')}); background-size: cover; background-position: center; border-style: solid;` : ''}">
                                                <input type="file" class="hidden widget-input" data-key="widget_avatar_me" accept="image/*">
                                                <span class="text-gray-400 text-xl ${localStorage.getItem('widget_avatar_me') ? 'hidden' : ''}">+</span>
                                            </label>
                                            <span class="text-[10px] text-gray-500">æˆ‘çš„å¤´åƒ</span>
                                        </div>
                                        <div class="flex flex-col items-center gap-1">
                                            <label class="relative w-16 h-16 aspect-square flex items-center justify-center border-2 border-dashed border-gray-300 rounded-full cursor-pointer overflow-hidden bg-gray-50 hover:bg-gray-100" style="${(localStorage.getItem('widget_avatar_lover')) ? `background-image: url(${localStorage.getItem('widget_avatar_lover')}); background-size: cover; background-position: center; border-style: solid;` : ''}">
                                                <input type="file" class="hidden widget-input" data-key="widget_avatar_lover" accept="image/*">
                                                <span class="text-gray-400 text-xl ${localStorage.getItem('widget_avatar_lover') ? 'hidden' : ''}">+</span>
                                            </label>
                                            <span class="text-[10px] text-gray-500">æ‹äººå¤´åƒ</span>
                                        </div>
                                    </div>
                                `;

                                // Bind input events
                                widgetConfigList.querySelectorAll('.widget-input').forEach(input => {
                                    input.onchange = (e) => handleImageUpload(e.target.files[0], input.dataset.key, tempWidgetData, input.parentElement);
                                });

                                // Bind save button event
                                saveWidgetConfigBtn.onclick = () => {
                                    if (Object.keys(tempWidgetData).length === 0) {
                                        alert('æ²¡æœ‰æ£€æµ‹åˆ°ä¿®æ”¹');
                                        return;
                                    }
                                    for (let key in tempWidgetData) {
                                        localStorage.setItem(key, tempWidgetData[key]);
                                    }
                                    alert('å°ç»„ä»¶é…ç½®å·²ä¿å­˜');
                                    if (window.updateWidgetDisplay) {
                                        window.updateWidgetDisplay();
                                    }
                                    tempWidgetData = {};
                                    initSettingsContent(); // Re-init all settings
                                };
                            }

                            // Initialize all parts of the settings page
                            initAppIconLogic();
                            initSettingsWidgetLogic();
                        }

                        const wallpaperUpload = appPage.querySelector('#wallpaper-upload');
                        const preview = appPage.querySelector('#wallpaper-preview-container');
                        let tempUrl = null;
                        const savedWp = localStorage.getItem('customWallpaper');
                        if (savedWp) {
                            preview.style.backgroundImage = `url(${savedWp})`;
                            preview.textContent = '';
                        }
                        wallpaperUpload.onchange = (e) => {
                            const f = e.target.files[0];
                            if (f) {
                                const r = new FileReader();
                                r.onload = (evt) => {
                                    tempUrl = evt.target.result;
                                    preview.style.backgroundImage = `url(${tempUrl})`;
                                    preview.textContent = '';
                                };
                                r.readAsDataURL(f);
                            }
                        };
                        appPage.querySelector('#save-wallpaper-btn').onclick = () => {
                            if (tempUrl) {
                                screen.style.backgroundImage = `url(${tempUrl})`;
                                localStorage.setItem('customWallpaper', tempUrl);
                                alert('å£çº¸å·²ä¿å­˜');
                            }
                        };
                        appPage.querySelector('#reset-settings-btn').onclick = () => {
                            if (confirm('é‡ç½®æ‰€æœ‰æ•°æ®ï¼Ÿ')) {
                                localStorage.clear();
                                location.reload();
                            }
                        };

                        initSettingsContent();
                    }
                    
                    const closeApp = () => {
                        if (appPage.classList.contains('closing')) return;
                        const iconRect = icon.getBoundingClientRect();
                        const screenRect = screen.getBoundingClientRect();
                        appPage.style.transformOrigin = `${((iconRect.left + iconRect.width / 2) - screenRect.left) / screenRect.width * 100}% ${((iconRect.top + iconRect.height / 2) - screenRect.top) / screenRect.height * 100}%`;
                        appPage.classList.add('closing');
                        document.getElementById('app-home-indicator').style.display = 'none';
                        appPage.addEventListener('animationend', () => appPage.classList.remove('active', 'closing'), { once: true });
                    };
                    if (appPage.querySelector('.close-btn')) {
                        appPage.querySelector('.close-btn').addEventListener('click', closeApp);
                    }
                    document.getElementById('app-home-indicator').addEventListener('click', closeApp);
                    
                    const iconRect = icon.getBoundingClientRect();
                    const screenRect = screen.getBoundingClientRect();
                    appPage.style.transformOrigin = `${((iconRect.left + iconRect.width / 2) - screenRect.left) / screenRect.width * 100}% ${((iconRect.top + iconRect.height / 2) - screenRect.top) / screenRect.height * 100}%`;
                    appPage.classList.add('active');
                    document.getElementById('app-home-indicator').style.display = 'block';
                }
            });
            
            const screen = document.querySelector('.screen');
            const savedWallpaper = localStorage.getItem('customWallpaper') || localStorage.getItem('wallpaper') || 'https://images.unsplash.com/photo-1500964757637-c85e8a162699?q=80&w=2703&auto=format&fit=crop';
            screen.style.backgroundImage = `url('${savedWallpaper}')`;
        });
    </script>
    <script src="api_handler.js"></script>
</body>
</html>
